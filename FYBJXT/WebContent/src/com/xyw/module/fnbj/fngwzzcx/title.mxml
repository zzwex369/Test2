<?xml version="1.0" encoding="utf-8"?>
<s:TitleWindow xmlns:fx="http://ns.adobe.com/mxml/2009" 
			   xmlns:s="library://ns.adobe.com/flex/spark" 
			   xmlns:mx="library://ns.adobe.com/flex/mx" 
			   xmlns:component = "com.xyw.sys.custom.component.*"
			   skinClass="com.xyw.sys.custom.skin.CustomTitleWindow"
			   title="信息修改" horizontalCenter="0" verticalCenter="0" backgroundColor="white"
			   chromeColor="#5CACEE" close = "removeWindow()" cornerRadius="5" width="1200" 
			   rollOut="overAndUp(event)"
			   rollOver="overAndUp(event)">
	<fx:Declarations>
		
		<s:RemoteObject id="f310Service" destination="f310Service" endpoint="{this.parentApplication.contextRoot}/messagebroker/amf" showBusyCursor="true">
			<s:method name="renewF310"  result="renewF310Handler(event)"/>
		</s:RemoteObject>
		
		<s:RemoteObject id="systemService" destination="systemService" endpoint="{this.parentApplication.contextRoot}/messagebroker/amf" showBusyCursor="true">
			<s:method name="getComboBoxData" result="getComboBoxDataHandler(event)"/>
		</s:RemoteObject>
		
		<mx:DateValidator id="dateValidator"  property="text"
						  inputFormat="yyyy-mm-dd" 
						  wrongLengthError="格式错误  正确格式例：2008-01-01"
						  wrongDayError="天数错误"
						  wrongMonthError="月份错误"
						  wrongYearError="年份错误"
						  invalidCharError="内容无效"
						  requiredFieldError="内容不能为空"/>
	</fx:Declarations>
	<fx:Style>
		@namespace s "library://ns.adobe.com/flex/spark";
		@namespace mx "library://ns.adobe.com/flex/mx";
		@namespace component "com.xyw.sys.custom.component.*";
		@namespace skin "com.xyw.sys.custom.skin.*";
		.textInput{
			skinClass:ClassReference("com.xyw.sys.custom.skin.CustomTextInputSkin");
		}
		.myLabel {
			fontSize:12px;
			paddingTop:4px;
		}
		.myGrid {
			verticalAlign:middle;
		}
		.myTextInput
		{
			fontFamily:微软雅黑;
		}
		.must {
			color:red;
			fontSize:20px;
			fontWeight:bold;
			paddingTop:5px;
		}
		.errorTip
		{
			font-size: 15;
			border-color: red;/* //控制背景色 */
			color: #fff;
			font-weight: bold;
			paddingBottom:1; 
			cornerRadius:5;
		}
	</fx:Style>
	<fx:Script>
		<![CDATA[
			import com.xyw.module.fnbj.model.F310;
			import com.xyw.module.fnbj.model.VF310;
			import com.xyw.sys.custom.component.CompMethod;
			import com.xyw.sys.model.ComboBoxDataRequest;
			import com.xyw.sys.model.SystemUser;
			
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.events.CloseEvent;
			import mx.events.FlexEvent;
			import mx.managers.PopUpManager;
			import mx.rpc.events.ResultEvent;
			import mx.utils.StringUtil;
			[Embed(source="images/del.png")] 
			private var delicon:Class; 
			[Embed(source="images/add.png")] 
			private var addicon:Class; 
			[Bindable]
			private var rowVGroup:int =1;
			[Bindable]
			private var systemUser:SystemUser =null;
			private var count:int=2;
			public var vf310:Object;
			private var f310:F310=new F310();;
			private var comboBoxDataRequest:ComboBoxDataRequest;
			private var arrayTip:Array=[null,null,null,null];//保存提示信息  objId:Object,objType:String,errorString:String,tip:ToolTip
			
			private function removeWindow():void
			{
				PopUpManager.removePopUp(this);
			}
			protected function creationCompleteHandler(event:FlexEvent):void
			{
				this.systemUser =this.parentApplication.systemUser;
				initializeComboBox();
			}
			
			private function initializeComboBox():void
			{
				comboBoxDataRequest =new ComboBoxDataRequest();
				comboBoxDataRequest.showPrompt =true;
				comboBoxDataRequest.flag ="D101";
				comboBoxDataRequest.sql ="select t.d101_01, t.d101_02 from D101 t where t.d101_01 = '" + this.systemUser.institutionCode + "' or t.d101_11 ='" + this.systemUser.institutionCode +"'";
				this.systemService.getComboBoxData(this.comboBoxDataRequest);
				
				comboBoxDataRequest = new ComboBoxDataRequest();
				comboBoxDataRequest.showPrompt = true;
				comboBoxDataRequest.sql = "select * from S301_06 t";
				comboBoxDataRequest.flag = "S301_06";
				this.systemService.getComboBoxData(this.comboBoxDataRequest);
				
			}
			
			
			/*-----------------返回数据放到赋值到下拉菜单-----------------*/
			private function getComboBoxDataHandler(event:ResultEvent):void
			{
				--count;
				var index:int=0;
				var comboBoxDataResponse:Object =event.result;
				var flag:String =comboBoxDataResponse.flag;
				var comboBoxDataList:ArrayCollection =comboBoxDataResponse.comboBoxDataList;
				
				if(flag =="D101"){
					index=CompMethod.getDropDownListSelectedIndex(comboBoxDataList,this.systemUser.institutionCode);
					this.institution.dataProvider =comboBoxDataList;
					this.institution.selectedIndex =index;
				}else if(flag == "S301_06"){
					index =CompMethod.getDropDownListSelectedIndex(comboBoxDataList,"1");
					this.F310_05.dataProvider = comboBoxDataList;
					this.F310_05.selectedIndex = index;
				}
				if(!count)
				{
					if(this.currentState=="zznormal")
						loadVF310ZZ();
					else
						loadVF310JZ();
				}
				
			}
			
			private function overAndUp(event:MouseEvent):void
			{
				if(event.type==MouseEvent.ROLL_OVER)
				{ 
					if(!arrayTip[3])
						arrayTip=CompMethod.showTip(arrayTip[0],arrayTip[1],arrayTip[2],arrayTip[3]);
					if(!this.hasEventListener(Event.ENTER_FRAME))
						this.addEventListener(Event.ENTER_FRAME,enterFrameHandler); 
				}else
				{
					this.removeEventListener(Event.ENTER_FRAME,enterFrameHandler);			
					arrayTip[3]=CompMethod.destoryTip(arrayTip[3]);		
				}
			}
			
			/***************显示删除提示信息*********************/
			private function enterFrameHandler(event:Event):void
			{
				if(arrayTip[3])	
					arrayTip=CompMethod.showTip(arrayTip[0],arrayTip[1],arrayTip[2],arrayTip[3]);		 
			}
			
			
			/**
			 *验证是否为空
			 */
			private function validateGWReason():Boolean
			{
				var num:int=0;
				for(var k:int=0;k<vgroup.numElements;k++)
				{
					var textInput:Object=vgroup.getElementAt(k);
					if(!StringUtil.trim(textInput.text))
						num++;
				}
				if(num==vgroup.numElements)
					return false;
				return true;
			}
			
			/**
			 *保存验证
			 */
			private function validatePerinata():void
			{
				if(arrayTip[3])
					return;
				if(StringUtil.trim(F310_07.text)=="")
				{
					Alert.show("请输入联系电话","系统提示");
					return ;
				}
				if(StringUtil.trim(F310_08.text)=="")
				{
					Alert.show("请输入孕周","系统提示");
					return ;
				}
				if(this.currentState=="zznormal")
				{
					if(!validateGWReason())
					{
						Alert.show("请输入筛查结果","系统提示");
						return ;
					}
					if(StringUtil.trim(Doctorname.text)=="")
					{
						Alert.show("请输入转诊医生","系统提示");
						return ;
					}
					
					if(StringUtil.trim(time.text)=="")
					{
						Alert.show("请输入转诊日期","系统提示");
						return ;
					} 
				}else if(this.currentState=="jznormal")
				{
					if(!validateGWReason())
					{
						Alert.show("请输入目前诊断结果","系统提示");
						return ;
					}
					if(StringUtil.trim(Doctorname.text)=="")
					{
						Alert.show("请输入接诊医生","系统提示");
						return ;
					}
					
					if(StringUtil.trim(time.text)=="")
					{
						Alert.show("请输入接诊日期","系统提示");
						return ;
					} 
				}
				saveF310();	
			}
			
			private function saveF310():void
			{
				f310.f31003=StringUtil.trim(F310_03.text);
				f310.f31004=DateField.stringToDate(F310_04.text,'YYYY-MM-DD');
				f310.f31005=F310_05.selectedItem.data;
				f310.f31006=StringUtil.trim(F310_06.text);
				f310.f31007=StringUtil.trim(F310_07.text);
				f310.f31008=StringUtil.trim(F310_08.text);
				if(this.currentState=="zznormal")
				{
					f310.f31009=getF309_10Text();
					f310.f31010=StringUtil.trim(Doctorname.text);
					f310.f31011=DateField.stringToDate(time.text,'YYYY-MM-DD');
					f310.f31012=institution.selectedItem.data;
					f310Service.renewF310(f310);
					
				}else if(this.currentState=="jznormal")
				{
					f310.f31009=vf310.f31009;
					f310.f31010=vf310.f31010;
					f310.f31011=vf310.f31011;
					f310.f31012=vf310.f31012;
					f310.f31013=getF309_10Text();
					f310.f31014=getF31014Select();
					f310.f31015=StringUtil.trim(Doctorname.text);
					f310.f31016=DateField.stringToDate(time.text,'YYYY-MM-DD');
					f310.f31017=institution.selectedItem.data;
					f310Service.renewF310(f310);
				}
				
			}
			
			/**
			 *得到诊断内容
			 */
			private function getF309_10Text():String
			{
				var str:String='';
				for(var k:int=0;k<vgroup.numElements;k++)
				{
					var textInput:Object=vgroup.getElementAt(k);
					if(StringUtil.trim(textInput.text))
						str+=(StringUtil.trim(textInput.text)+"!");
				}
				return  str; 
			}
			
			/**
			 *得到风险级别
			 */
			private function getF31014Select():String
			{
				for(var i:int=1;i<=hgroup.numElements;i++)
				{
					var radioButton:Object=hgroup.getElementAt(i);
					if(radioButton.selected)
						return (++i).toString();
				}
				return "";
			}
			
			
			/**
			 *时间输入验证
			 */
			private function focusOut(id:Object):Boolean
			{
				var textDate:Date=DateField.stringToDate(id.text,"YYYY-MM-DD");
				if(id.errorString&&!textDate)
				{
					var str:String=id.errorString;
					id.errorString='';
					dateValidator.source=null;
					if((str.lastIndexOf("yyyy-mm-dd"))!=-1)
						str=str.substring(0,str.lastIndexOf("yyyy-mm-dd"));
					//保存提示信息  objId:Object,objType:String,errorString:String,tip:ToolTip
					arrayTip=CompMethod.showTip(id,"3",str,arrayTip[3]);
					return true;
				}else
					return dateValidatorHandler(id,textDate);
			}
			
			/**
			 *清空提示 格式化日期
			 */
			private function dateValidatorHandler(id:Object,textDate:Date):Boolean
			{
				dateValidator.source=null;
				id.errorString='';
				if(arrayTip[3])
				{
					CompMethod.destoryTip(arrayTip[3]);	
					arrayTip=[null,null,null,null]
				}					
				if(textDate)
					id.text=DateField.dateToString(textDate,"YYYY-MM-DD");
				return false;
			}
			
			
			/**
			 *读卡
			 */
			private function readCard_mother(event:MouseEvent):void
			{
				try
				{
					var array:Array = CompMethod.readCard();
					var flag:Boolean=CompMethod.sex('女',array[1])
					if(flag){
						this.F310_03.text = array[0];//姓名
						this.F310_06.text = array[5];//身份证号
						this.F310_04.text = array[3];//出生日期
						var nation:String = array[2] + "族";//民族
					}else{
						Alert.show("请读母亲信息！","系统提示");
					}
				} 
				catch(error:Error) 
				{
					Alert.show("读卡失败！");
				}
			}
			
			
			/**
			 *添加行
			 */
			private function addRowHandler(event:FlexEvent):void
			{
				if(rowVGroup==5)
					return ;
				tab.height+=21;
				navigator.height+=21;
				vgroup.height+=20;
				var text:TextInput=new TextInput();
				text.width=859;
				text.setFocus();
				text.styleName='textInput';
				text.setStyle("height",20);
				text.setStyle('paddingLeft',20);
				text.addEventListener(FlexEvent.ENTER,addRowHandler);
				vgroup.addElementAt(text,vgroup.numElements);
				rowVGroup=vgroup.numElements;
			}
			/**
			 *删除行
			 */
			private function delRowHandler(event:MouseEvent):void
			{
				tab.height-=21;
				navigator.height-=21;
				vgroup.height-=20;
				vgroup.removeElementAt(vgroup.numElements-1);
				rowVGroup=vgroup.numElements;
			}
			
			
			private function renewF310Handler(event:ResultEvent):void
			{
				var f310Response:Object=event.result;
				if(f310Response.state)
				{
					Alert.show(f310Response.promptMessage+",点击确定即将关闭","系统提示",1,this,closeHander);
				}else
					Alert.show(f310Response.errorMessage,"系统提示");
			}
			
			private function closeHander(event:CloseEvent):void
			{
				if(event.detail==1)
				{
					var index:Object=this.owner;
					index.refresh();
					this.removeWindow();
				}
			}
			
			/**
			 *根据高危原因动态添加行数
			 */
			private function setGWReasonRow(str:String):void
			{
				var strArr:Array=str.split("!");
				var length:int=(strArr.length)-2;
				for(var i:int=0;i<length;i++)
				{
					addRowHandler(null);
				}
				for(var j:int=0;j<vgroup.numElements;j++)
				{
					var textInput:Object=vgroup.getElementAt(j);
					textInput.text=strArr[j].toString();
				}  
			}
			/**
			 *加载转诊信息
			 */
			private function loadVF310ZZ():void
			{
				loadVF310();
				f310.f31014=vf310.f31014;
				Doctorname.text=vf310.f31010;
				time.text=DateField.dateToString(vf310.f31011,'YYYY-MM-DD');
				institution.selectedIndex=CompMethod.getDropDownListSelectedIndex(ArrayCollection(institution.dataProvider),vf310.f31012);
			}
			/**
			 *加载接诊信息
			 */
			private function loadVF310JZ():void
			{
				loadVF310();
				Doctorname.text=vf310.f31015;
				time.text=DateField.dateToString(vf310.f31016,'YYYY-MM-DD');
				institution.selectedIndex=CompMethod.getDropDownListSelectedIndex(ArrayCollection(institution.dataProvider),vf310.f31017);
				var index:int=Number(vf310.f31014);
				(hgroup.getElementAt(--index) as RadioButton).selected=true;
			}
			/**
			 *加载基础信息
			 */
			private function loadVF310():void
			{
				f310.f31001=vf310.f31001;
				f310.f31002=vf310.f31002;
				F310_03.text=vf310.f31003;
				F310_04.text=DateField.dateToString(vf310.f31004,'YYYY-MM-DD');
				F310_05.selectedIndex=CompMethod.getDropDownListSelectedIndex(ArrayCollection(F310_05.dataProvider),vf310.f31005);
				F310_06.text=vf310.f31006;
				F310_07.text=vf310.f31007;
				F310_08.text=vf310.f31008;
				age.text=CompMethod._getAge(F310_04.text);
			}
			
			protected function vgroup1_creationCompleteHandler(event:FlexEvent):void
			{
				if(vf310.f31013)
					setGWReasonRow(vf310.f31013);
				else
					setGWReasonRow(vf310.f31009);
				
			}
			
		]]>
	</fx:Script>
	<s:states>
		<s:State name="zznormal" enterState="creationCompleteHandler(event)"/>		
		<s:State name="jznormal" enterState="creationCompleteHandler(event)"/>			
	</s:states>
	<s:Scroller x="-6" y="1" width="100%" height="100%" horizontalScrollPolicy="auto" verticalScrollPolicy="auto" >
		<s:VGroup  paddingBottom="20" paddingLeft="10" paddingRight="10" paddingTop="10" creationComplete="vgroup1_creationCompleteHandler(event)">
			<mx:TabNavigator id="content" width="1155" chromeColor="#ffffff" creationPolicy="all">
				<s:NavigatorContent width="100%" label="基本信息">
					<mx:Grid paddingLeft="8" paddingBottom="10">
						<mx:GridRow>
							<mx:GridItem>
								<s:Label styleName="myLabel" text="孕 妇  姓 名"/>	
								<s:TextInput id="F310_03" width="130" editable="false"/>	
							</mx:GridItem>
							<mx:GridItem>
								<s:Label styleName="myLabel"  text="证件类型" paddingLeft="15"/>
								<component:CustomDropDownList id="F310_05" width="130" enabled="false"/>
								
							</mx:GridItem>
							<mx:GridItem>
								<s:Label styleName="myLabel"  text="证件号码" paddingLeft="15"/>
								<s:TextInput id="F310_06" width="140" editable="false"/>
								
							</mx:GridItem>
							<mx:GridItem>
								<s:Label styleName="myLabel"  text="出生日期" paddingLeft="15"/>
								<mx:DateField id="F310_04" width="130"
											  dayNames="[&quot;周日&quot;,&quot;周一&quot;,&quot;周二&quot;,&quot;周三&quot;,&quot;周四&quot;,&quot;周五&quot;,&quot;周六&quot;]"
											  formatString="YYYY-MM-DD"
											  monthNames="[&quot;一月&quot;,&quot;二月&quot;,&quot;三月&quot;,&quot;四月&quot;,&quot;五月&quot;,&quot;六月&quot;,&quot;七月&quot;,&quot;八月&quot;,&quot;九月&quot;,&quot;十月&quot;,&quot;十一月&quot;,&quot;十二月&quot;]"
											  enabled="false" yearNavigationEnabled="true"
											  />
								
								<s:Button id="duka2"  label="读卡" buttonMode="true"
										  click="readCard_mother(event)"
										  enabled="{systemUser.duka =='1'}"/>
							</mx:GridItem>
						</mx:GridRow>
						<mx:GridRow>	
							<mx:GridItem>
								<s:Label styleName="myLabel"  text="年            龄" />
								<s:TextInput id="age" restrict="0-9" maxChars="2" editable="false"/>
								
							</mx:GridItem>
							
							<mx:GridItem>
								<s:Label styleName="myLabel"  text="联系电话" paddingLeft="15" />
								<s:TextInput id="F310_07" restrict="0-9"
											 focusIn="arrayTip=CompMethod.showTip(age,'1','请输入年龄',arrayTip[3])"
											 editable="false" />
								
							</mx:GridItem>
							
							<mx:GridItem colSpan="2">
								<s:Label styleName="myLabel"  text="孕        周 " paddingLeft="15"/>
								<s:TextInput id="F310_08" maxChars="2" width="140" restrict="0-9"  text="40"
											 focusIn="arrayTip=CompMethod.showTip(F310_07,'1','请输入联系电话',arrayTip[3])"
											 editable="false" />
								
							</mx:GridItem>
						</mx:GridRow>
					</mx:Grid>
				</s:NavigatorContent>
			</mx:TabNavigator>
			<mx:TabNavigator width="1155" chromeColor="#ffffff" creationPolicy="all" id="tab">
				<s:NavigatorContent width="100%" label="评估内容" id="navigator">	
					<mx:Grid paddingLeft="8" paddingBottom="10" id="grid">
						<mx:GridRow paddingTop="5" >
							<mx:GridItem paddingLeft="10">
								<s:Label styleName="myLabel"  text.zznormal="目前诊断："
										 text.jznormal="筛查结果（主要危险因素）"/>
								<s:Label styleName="myLabel"  text="(友情提示，在本行按回车添加行或者点击按钮)" color="red"/>
								<s:Button label="添加行" click="addRowHandler(null)" icon="{addicon}" enabled="{rowVGroup&lt;5}" iconPlacement="left"/>
								<s:Button label="删除行" click="delRowHandler(event)" icon="{delicon}" enabled="{rowVGroup&gt;1}" iconPlacement="left"/>
							</mx:GridItem>
						</mx:GridRow>
						<mx:GridRow id="gridRow" width="1000">
							<mx:GridItem paddingLeft="55" id="gridItem" width="100%">
								<s:VGroup id="vgroup" width="100%">
									<s:TextInput width="859" height="20" id="textStr"  enter="addRowHandler(null)" 
												 styleName="textInput"/>
								</s:VGroup>
							</mx:GridItem>
						</mx:GridRow>
						<mx:GridRow includeIn="jznormal">
							<mx:GridItem paddingLeft="10">
								<s:Label styleName="myLabel"  text="妊娠风险评估分级 （请在相关项目上选择）："/>
							</mx:GridItem>
						</mx:GridRow>
						<mx:GridRow includeIn="jznormal">
							<mx:GridItem paddingLeft="10"> 
								<s:HGroup width="100%" gap="80" horizontalAlign="center" id="hgroup">
									<s:RadioButton label="绿色" value="1" id="F310_14_01" buttonMode="true"/>
									<s:RadioButton label="黄色" value="2" id="F310_14_02" buttonMode="true" selected="true"/>
									<s:RadioButton label="橙色" value="3" id="F310_14_03" buttonMode="true"/>
									<s:RadioButton label="红色" value="4" id="F310_14_04" buttonMode="true"/>
									<s:RadioButton label="紫色" value="5" id="F310_14_05" buttonMode="true"/>
								</s:HGroup>
							</mx:GridItem>
						</mx:GridRow>
					</mx:Grid>
				</s:NavigatorContent>
			</mx:TabNavigator>
			<mx:TabNavigator width="1155" chromeColor="#ffffff" creationPolicy="all">
				<s:NavigatorContent width="100%" label="登记信息">	
					<mx:Grid paddingLeft="8" paddingBottom="10">
						<mx:GridRow >
							<mx:GridItem>
								<s:Label styleName="myLabel"  text="医生签名"/>
								<s:TextInput id="Doctorname" width="130"
											 focusIn="if(!validateGWReason())arrayTip=CompMethod.showTip(textStr,'1','请填写初步诊断内容!',arrayTip[3])"/>
							</mx:GridItem>
							<mx:GridItem>
								<s:Label styleName="myLabel"   
										 text.zznormal="转诊机构" 
										 text.jznormal="接诊机构" 
										 paddingLeft="20"/>
								<component:CustomDropDownList id="institution" width="130" enabled="false"  />
							</mx:GridItem>
							<mx:GridItem>
								<s:Label styleName="myLabel"  text.zznormal="转诊时间" 
										 text.jznormal="接诊时间" 
										 paddingLeft="10"/>
								<mx:DateField yearNavigationEnabled="true" id="time" width="140" dayNames='["周日","周一","周二","周三","周四","周五","周六"]'
											  monthNames='["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"]'
											  formatString="YYYY-MM-DD" editable="true" text="{DateField.dateToString(new Date(),'YYYY-MM-DD')}" 
											  focusIn="dateValidator.source=time;arrayTip=CompMethod.showTip(Doctorname,'1','请填写医生签名!',arrayTip[3])"
											  focusOut="focusOut(time)" 
											  restrict="0-9\-"/>
								
								
							</mx:GridItem>
						</mx:GridRow>
						
					</mx:Grid>
				</s:NavigatorContent>
			</mx:TabNavigator>
			<s:HGroup verticalAlign="middle" horizontalAlign="center" paddingBottom="5" paddingTop="5" width="1155">
				<s:Button buttonMode="true" label="保存" click="validatePerinata()" enabled="{F310_03.text}" chromeColor="#cccccc"/>
			</s:HGroup>
		</s:VGroup>
	</s:Scroller>
</s:TitleWindow>
