<?xml version="1.0" encoding="utf-8"?>
<s:Module xmlns:fx="http://ns.adobe.com/mxml/2009" 
		  xmlns:s="library://ns.adobe.com/flex/spark" 
		  xmlns:mx="library://ns.adobe.com/flex/mx"
		  width="100%" height="100%"
		  creationComplete="moduleCreationCompleteHandler(event)"
		  xmlns:component="com.xyw.sys.custom.component.*">
	<fx:Declarations>
		<s:RemoteObject id="governmentService" destination="governmentService" endpoint="{this.parentApplication.contextRoot}/messagebroker/amf" showBusyCursor="true">
			<s:method name="queryD402" result="queryHandler(event)" />
		</s:RemoteObject>
	</fx:Declarations>
		<fx:Style>
		@namespace s "library://ns.adobe.com/flex/spark";
		@namespace mx "library://ns.adobe.com/flex/mx";
		
		s|DropDownList
		{
			skinClass:ClassReference("com.xyw.sys.custom.skin.CustomDropDownListSkin");
			selectionColor:#DDDDDD;
			rollOverColor:#EEEEEE;	
			cornerRadius:3;
		}
		s|Button
		{
			skinClass:ClassReference("com.xyw.sys.custom.skin.CustomButtonSkin");
			cornerRadius:5;
		}
		s|Label
		{
			fontSize:13;
		}
		s|DataGrid
		{
			borderAlpha:"0.3";
			alternatingRowColors:"[#FFFFFF,#EEEEEE]";
			skinClass:ClassReference("com.xyw.sys.custom.skin.CustomDataGridSkin");
		}
	</fx:Style>
	<fx:Script>
		<![CDATA[
			import com.xyw.module.submitQuestion.model.D402;
			import com.xyw.module.submitQuestion.model.D402Request;
			import com.xyw.module.submitQuestion.model.VD402;
			import com.xyw.sys.constant.SystemConstant;
			import com.xyw.sys.custom.component.SecurityControler;
			import com.xyw.sys.model.SessionException;
			import com.xyw.sys.model.SystemUser;
			
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.controls.DateField;
			import mx.events.FlexEvent;
			import mx.formatters.DateFormatter;
			import mx.managers.PopUpManager;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			
			import spark.events.GridSelectionEvent;
			import spark.formatters.DateTimeFormatter;
			
			[Bindable]
			public var vd402:VD402 = null;
			
			public var d402:D402;
			
			public var d402Request:D402Request = new D402Request();;
			
			public var systemUser:SystemUser = null;
			
			//**************启动权限控制**************//
			private function security():void{
				SecurityControler.start(null,'visible');
				SecurityControler.addAllPerms(this.parentApplication.permissionList);
				//this.shenhe.enabled=SecurityControler.isPermitted('shenhe.swf');
				//this.cl.enabled=SecurityControler.isPermitted('chuli.swf');
			}
			
			private function shenhe_refresh(event:Event):void{
			//	Alert.show("fffff");
				d402Request = new D402Request();
				d402 = new D402();
				d402_10_1.selected=true;
				this.initQueryParam();
				d402.d402_10 = "1";
				d402Request.parameterPageindex = this.pagerBar.currentPageIndex;
				d402Request.parameterPagesize = 20;
				
				d402Request.d402 = d402;
				
				this.governmentService.queryD402(d402Request);
			}
			
			private function moduleCreationCompleteHandler(event:FlexEvent):void
			{
				security();
				this.systemUser = this.parentApplication.systemUser;
				
				if(this.systemUser.institutionCode  == '4113000000000102'){
					this.shenhe.enabled=true;
					this.cl.enabled=true;
				}
				
				this.certificateApplyDataGrid.addEventListener(GridSelectionEvent.SELECTION_CHANGE, onSelectionChange);
				
				//				
				var dateStr:String = DateField.dateToString(new Date(),"YYYY-MM-01");
				this.d402_12.selectedDate = DateFormatter.parseDateString(dateStr);
				this.d402_12End.selectedDate = new Date();
				//				
				//		this.d402_10.dataProvider = new ArrayCollection([{label:"选择", data:""},{label:"未审核", data:"0"},{label:"已审核", data:"1"}]);
				//		this.d402_19.dataProvider = new ArrayCollection([{label:"选择", data:""},{label:"未处理", data:"0"},{label:"已处理", data:"1"}]);
				//		this.d402_19.selectedIndex = 0;
				//		this.d402_10.selectedIndex = 0;
				var dateformatter:DateFormatter = new DateFormatter();
				
			}
			
			private function initQueryParam():void
			{
				try
				{
					var type:String = this.d402_11.getLastSelectedInstitution();
					var d402_11_:String = this.d402_11.getLastSelectedInstitutionCode();
					if(this.systemUser.institutionType == "1")
					{
						d402.d402_11 = this.systemUser.institutionCode;
					}
					else
					{
						if(type == "8")
						{
							d402.d402_11 = d402_11_;
						}else if(type == "6")
						{
							d402.d402_11 = d402_11_.substring(0,6);
						}else if(type == "4")
						{
							d402.d402_11 = d402_11_.substring(0,4);
						}else if(type == "2")
						{
							d402.d402_11 = d402_11_.substring(0,2);
						}
					}
					d402.d402_02 = this.d402_02.text;
					d402.d402_03 = this.d402_03.text;
					d402.d402_12 = this.d402_12.selectedDate;
					d402.d402_12_end = this.d402_12End.selectedDate;
					//		d402.d402_10 = this.d402_10.selectedItem.data;
					//		d402.d402_19 = this.d402_19.selectedItem.data;
					if(this.d402_10.selected){
						d402.d402_10 = "0";
					}else if(this.d402_10_1.selected){
						d402.d402_10 = "1";
					}else if(this.d402_10_2.selected){
						d402.d402_10 = "";
					}
					if(this.d402_19.selected){
						d402.d402_19 = "0";
					}else if(this.d402_19_1.selected){
						d402.d402_19 = "1";
					}else if(this.d402_19_2.selected){
						d402.d402_19 = "";
					}
					d402Request.d402 = this.d402;
				}
				catch(error:Error) 
				{
					
				}
			}
			
			private function query(event:MouseEvent):void
			{
				d402 = new D402();
				this.initQueryParam();
				
				d402Request.parameterPageindex = 1;
				d402Request.parameterPagesize = 20;
				
				this.governmentService.queryD402(d402Request);
			}
			
			private function queryHandler(event:ResultEvent):void
			{
				var d402Response:Object = event.result;
				var rowCount:Number = d402Response.rowCount;
				if(d402Response.errorMessage == null) {
					var vd402s:ArrayCollection = d402Response.vd402s;
					this.pagerBar.dataGrid = this.certificateApplyDataGrid;
					this.pagerBar.rowCount = rowCount;
					this.pagerBar.resultData = vd402s;
					this.pagerBar.dataBind();
					this.pagerBar.pagerFunction = this.pagerFunction;
					if(rowCount > 0) {
						this.pagerBar.enabled = true;
					} else {
						Alert.show("暂无数据!", "系统提示");
					}
				} else {
					Alert.show(d402Response.errorMessage, "系统提示");
				}
			}
			
			public function pagerFunction(currentPageIndex:int, pageSize:int):void
			{
				d402Request = new D402Request();
				d402 = new D402();
				this.initQueryParam();
				
				d402Request.parameterPageindex = currentPageIndex;
				d402Request.parameterPagesize = pageSize;
				this.governmentService.queryD402(d402Request);
				
			}
			
			public function refresh():void
			{
				d402Request = new D402Request();
				d402 = new D402();
				this.initQueryParam();
				
				d402Request.parameterPageindex = this.pagerBar.currentPageIndex;
				d402Request.parameterPagesize = 20;
				
				d402Request.d402 = d402;
				
				this.governmentService.queryD402(d402Request);
			}
			
			
			private function onSelectionChange(event:GridSelectionEvent):void
			{
				this.vd402 = DataGrid(event.target).selectedItem as VD402;
				
			}
			
			private function deal():void
			{
				if(this.vd402.d40210 == "1"){
					Alert.show("已经审核请不要重复审核！","系统提示");
					return;
				}
				if(this.vd402 == null)
				{
					Alert.show("请选择要操作的行!", "系统提示");
					return;
				}
				var window:DealHandleTitleWindow = new DealHandleTitleWindow();
				window.owner = this;
				PopUpManager.addPopUp(window,this);
				var x:Number = (this.parentApplication.mdiCanvas.width - window.width) / 2;
				var y:Number = (this.parentApplication.mdiCanvas.height - window.height) / 2;
				window.move(x, y);
				window.vd402 = this.vd402;
				window.addEventListener("ok_click",shenhe_refresh);
			//	Alert.show("dddd");
			}
			private function chuli():void
			{
				if(this.vd402.d40210 == "0"){
					Alert.show("请先审核再处理！","系统提示");
					return;
				}
				if(this.vd402.d40219 == "1"){
					Alert.show("已处理请不要重复处理！", "系统提示");
					return;
				}
				if(this.vd402 == null){
					Alert.show("请选择要操作的行！","系统提示");
					return;
				}
				
				var window:ChuliHandleTitleWindow = new ChuliHandleTitleWindow();
				window.owner = this;
				PopUpManager.addPopUp(window,this);
				var x:Number = (this.parentApplication.mdiCanvas.width - window.width)/2;
				var y:Number = (this.parentApplication.mdiCanvas.height - window.height)/2;
				window.move(x,y);
				window.vd402 = this.vd402;
				
			}
			private function faultHandler(event:FaultEvent):void
			{
				var sessionException:SessionException = event.fault.rootCause as SessionException;
				var errorCode:String = "";
				try {
					errorCode = sessionException.errorCode;
					if(errorCode == SystemConstant.LOGIN_USER_INFO_IS_NULL) {
						Alert.show(sessionException.errorMessage, "系统提示");
						return;
					}
				} catch(error:Error) {
					Alert.show("系统异常", "系统提示");
				}
			}
			
			private function formatDateToStringD40212AndD40213(vd402:Object, column:GridColumn):String
			{
				var dateTimeFormatter:DateTimeFormatter = new DateTimeFormatter();
				dateTimeFormatter.dateTimePattern = "yyyy-MM-dd";
				var columnDataField:String = column.dataField;
				if("d40212" == columnDataField) {
					var date_D40212:Date = vd402.d40212;
					var date_D40212_Text:String = dateTimeFormatter.format(date_D40212);
					
					return date_D40212_Text;
				} else if("d40213" == columnDataField) {
					var date_D40213:Date = vd402.d40213;
					var date_D40213_Text:String = dateTimeFormatter.format(date_D40213);
					return date_D40213_Text;
				}
				return null;
			}
			
			private function wtxq():void{
				if(this.vd402 == null){
					Alert.show("请选择要操作的行！","系统提示");
					return;
				}
				var window:WTXQHandleTitleWindow = new WTXQHandleTitleWindow();
				window.owner = this;
				PopUpManager.addPopUp(window,this);
				var x:Number = (this.parentApplication.mdiCanvas.width - window.width)/2;
				var y:Number = (this.parentApplication.mdiCanvas.height - window.height)/2;
				window.move(x,y);
				window.vd402 = this.vd402;
			}
		]]>
	</fx:Script>
	<s:VGroup width="100%">
		<mx:TabNavigator  width="100%" chromeColor="#ffffff" creationPolicy="all">
			<s:NavigatorContent id="wentichaxun" label="问题处理查询" width="100%">
				<s:VGroup>
					<s:HGroup width="100%" paddingBottom="5" paddingLeft="10" paddingRight="10" verticalAlign="middle">
						<s:Label text="申请医院"/><!--s:DropDownList id="d402_10"/ -->
						<component:InstitutionComboBox id="d402_11"/>
						<s:Label text="姓名"/><s:TextInput id="d402_02" />
						<s:Label text="出生证号"/><s:TextInput id="d402_03" />
					</s:HGroup>
					<s:HGroup width="100%" paddingBottom="5" paddingLeft="10" paddingRight="10" verticalAlign="middle">
						<s:Label text="申请时间"/><!--<mx:DateField id="d402_12" yearNavigationEnabled="true" width="120" dayNames='["日","一","二","三","四","五","六"]'
						monthNames='["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"]'
						formatString="YYYY-MM-DD"/>-->
						<component:CustomRangeDateField  id="d402_12" isSelectNow="true" isQuerySysDate="false" getRangesDate="{d402_12End.disabledRanges}"/>
						<s:Label text="至"/>
						<component:CustomRangeDateField  id="d402_12End"  isSelectNow="true"/>
						<!--<mx:DateField id="d402_12End" yearNavigationEnabled="true" width="120" dayNames='["日","一","二","三","四","五","六"]'
						monthNames='["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"]'
						formatString="YYYY-MM-DD"/>-->
						<s:Label text="是否审核"/><!--<s:DropDownList id="d402_10"/>-->
						<s:RadioButton label="全部" id="d402_10_2" selected="false" groupName="sh"/>
						<s:RadioButton label="未审核" id="d402_10" selected="true" groupName="sh" />
						<s:RadioButton label="已审核" id="d402_10_1" selected="false" groupName="sh"/>
						<s:Label text="是否处理"/><!--<s:DropDownList id="d402_19"/>-->
						<s:RadioButton label="全部" id="d402_19_2" selected="false" groupName="chu" />
						<s:RadioButton label="未处理" id="d402_19" selected="true" groupName="chu" />
						<s:RadioButton label="已处理" id="d402_19_1" selected="false" groupName="chu" />
						<s:Button label="查询" click="query(event)" skinClass="com.xyw.sys.custom.skin.CustomButtonSkin"/>
						<s:Button label="审核" id="shenhe" click="deal()" skinClass="com.xyw.sys.custom.skin.CustomButtonSkin"/>
						<s:Button label="处理" id="cl" click="chuli()" skinClass="com.xyw.sys.custom.skin.CustomButtonSkin"/>
						<s:Button label="详情" id="xiangqing" click="wtxq()" skinClass="com.xyw.sys.custom.skin.CustomButtonSkin"/>
					</s:HGroup>	
				</s:VGroup>
			</s:NavigatorContent>
		</mx:TabNavigator>
		<s:Scroller width="100%" height="490" horizontalScrollPolicy="auto"
					verticalScrollPolicy="auto">
			<s:VGroup width="100%" paddingBottom="10">
				<s:DataGrid id="certificateApplyDataGrid" editable="true" textAlign="center" rowHeight="22" width="100%" height="340" alternatingRowColors="[#FFFFFF,#EEEEEE]" skinClass="com.xyw.sys.custom.skin.CustomDataGridSkin">  
					<s:columns>
						<s:ArrayList>
							<s:GridColumn headerText="序号" width="40" itemRenderer="com.xyw.sys.custom.itemrenderer.CustomGridColumnItemRenderer" editable="false"/>
							<s:GridColumn dataField="d40201" headerText="主键" visible="false"/>
							<s:GridColumn dataField="d40202" headerText="姓名" width="50"/>
							<s:GridColumn dataField="d40203" headerText="出生证号" width="100"/>
							<s:GridColumn dataField="d40204" headerText="母亲姓名" width="80"/>
							<s:GridColumn dataField="d40205" width="150" headerText="母亲身份证号"/>
							<s:GridColumn dataField="d40206" headerText="父亲姓名" visible="false"/>
							<s:GridColumn dataField="d40207" width="150" headerText="父亲身份证号"/>
							<s:GridColumn dataField="d40211Zh" headerText="申请医院" width="100"/>
							<s:GridColumn dataField="d40210Zh" headerText="审核标志" width="67"/>
							<s:GridColumn dataField="d40210" headerText="审核标志代码" visible="false"/>
							<s:GridColumn dataField="d40219Zh" headerText="处理标志" width="67"/>
							<s:GridColumn dataField="d40219" headerText="处理标志代码" visible="false"/>
							<s:GridColumn dataField="d40220Zh" headerText="打印标志" width="67"/>
							<s:GridColumn dataField="d40212" headerText="申请时间" width="75" labelFunction="formatDateToStringD40212AndD40213" editable="false"/>
							<s:GridColumn dataField="d40208" headerText="错误信息描述" width="150"/>
							<s:GridColumn dataField="d40209" headerText="修改信息描述" width="150"/>
							<s:GridColumn dataField="d40217" headerText="处理信息" width="80"/>
							<s:GridColumn dataField="d40210" headerText="审核标志" visible="false"/>
							<s:GridColumn dataField="d40213" headerText="审核时间" visible="false"/>
							
							<s:GridColumn dataField="d40214" headerText="备注" visible="false"/>
							<s:GridColumn dataField="d40215" headerText="备注" visible="false"/>
							<s:GridColumn dataField="d40216" headerText="备注" visible="false"/>
							<s:GridColumn dataField="d40217" headerText="备注" visible="false"/>
							<s:GridColumn dataField="d40218" headerText="备注" visible="false"/>
							<s:GridColumn dataField="d40219" headerText="备注" visible="false"/>
							<s:GridColumn dataField="d40220" headerText="备注" visible="false"/>
							<s:GridColumn dataField="d40221" headerText="备注" visible="false"/>
							
							<s:GridColumn dataField="d40222" headerText="备注" visible="false"/>
							<s:GridColumn dataField="d40223" headerText="备注" visible="false"/>
							<s:GridColumn dataField="d40224" headerText="备注" visible="false"/>
							<s:GridColumn dataField="d40225" headerText="备注" visible="false"/>
							<s:GridColumn dataField="d40226" headerText="备注" visible="false"/>
							<s:GridColumn dataField="d40227" headerText="备注" visible="false"/>
							<s:GridColumn dataField="d40228" headerText="备注" visible="false"/>
							<s:GridColumn dataField="d40229" headerText="备注" visible="false"/>
							<s:GridColumn dataField="d40230" headerText="备注" visible="false"/>
						</s:ArrayList>
					</s:columns>
				</s:DataGrid>
				<component:PagerBar id="pagerBar" isExcel="false" isExcel2="false" isPrinter="false" enabled="false"/>
			</s:VGroup>
		</s:Scroller>
	</s:VGroup>
</s:Module>