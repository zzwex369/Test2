<?xml version="1.0" encoding="utf-8"?>
<s:TitleWindow xmlns:fx="http://ns.adobe.com/mxml/2009" 
			   xmlns:s="library://ns.adobe.com/flex/spark" 
			   xmlns:mx="library://ns.adobe.com/flex/mx" 
			   xmlns:component="com.xyw.sys.custom.component.*"
			   title="标本审核" backgroundColor="#FFFFFF"
			   chromeColor="#5CACEE"  cornerRadius="5"
			   close="removeWindow()"
			   creationComplete="creationCompleteHandler(event)">
	<fx:Declarations>
		<s:RemoteObject id="f601Service" destination="f601Service" endpoint="{this.parentApplication.contextRoot}/messagebroker/amf" showBusyCursor="true">
			<s:method name="renewF601" result="renewF601Handler(event)"/>
		</s:RemoteObject>
		
		<s:RemoteObject id="systemService" destination="systemService" endpoint="{this.parentApplication.contextRoot}/messagebroker/amf" showBusyCursor="true">
			<s:method name="getComboBoxData" result="getComboBoxDataHandler(event)"/>
		</s:RemoteObject>
	</fx:Declarations>
	
	<fx:Script>
		<![CDATA[
			import com.as3xls.xls.Obj;
			import com.xyw.module.msss.fnbj.model.F601;
			import com.xyw.module.msss.fnbj.model.F601Request;
			import com.xyw.sys.custom.component.CompMethod;
			import com.xyw.sys.model.ComboBoxDataRequest;
			import com.xyw.sys.model.SystemUser;
			
			import mx.accessibility.DateFieldAccImpl;
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.events.CloseEvent;
			import mx.events.FlexEvent;
			import mx.managers.PopUpManager;
			import mx.rpc.events.ResultEvent;
			import mx.utils.StringUtil;
			private var comboBoxDataRequest:ComboBoxDataRequest;
			public var systemUser:SystemUser =null;
			public var state:String="";
			public var checkMethod:String="";
			public var itemArr:ArrayCollection=null;
			private var f60101list:ArrayCollection=null;
			private var f601:F601=null;
			private var f60155:String=null;
			protected function creationCompleteHandler(event:FlexEvent):void
			{
				this.setFocus();
				this.addEventListener(KeyboardEvent.KEY_UP,save_keyUpHandler);
				this.currentState=state;
				if(itemArr)
				{
					f60101list=new ArrayCollection();
					for(var i:int=0;i<itemArr.length;i++)
					{
						var vf601:Object=itemArr.getItemAt(i);
						f60101list.addItem(vf601.f60101);
						if(checkMethod)
							f60155=vf601.f60155.toString();
					}
				}
				
			}
			
			private function removeWindow():void
			{
				var index:Object=this.owner;
				if(checkMethod)
					index.queryF60155(f60155);
				PopUpManager.removePopUp(this);
			}
			
			protected function state1_enterStateHandler(event:FlexEvent):void
			{
				this.systemUser =this.parentApplication.systemUser;
				
				comboBoxDataRequest =new ComboBoxDataRequest();
				comboBoxDataRequest.showPrompt =false;
				comboBoxDataRequest.flag ="D101";
				comboBoxDataRequest.sql ="select t.d101_01, t.d101_02 from D101 t where t.d101_01 = '" + this.systemUser.institutionCode + "' or t.d101_11 ='" + this.systemUser.institutionCode +"'";
				this.systemService.getComboBoxData(this.comboBoxDataRequest);
				
				
				comboBoxDataRequest = new ComboBoxDataRequest();
				comboBoxDataRequest.showPrompt = false;
				comboBoxDataRequest.sql = "select t.s_01,t.s_02 from S301_10 t where t.S_05='7' and t.S_04 ="+systemUser.userCode;
				comboBoxDataRequest.flag = "S301_10";
				this.systemService.getComboBoxData(comboBoxDataRequest);
			}
			
			private function getComboBoxDataHandler(event:ResultEvent):void
			{
				var comboBoxDataResponse:Object =event.result;
				var flag:String =comboBoxDataResponse.flag;
				var comboBoxDataList:ArrayCollection =comboBoxDataResponse.comboBoxDataList;
				
				if(flag =="D101"){
					var index:int =CompMethod.getDropDownListSelectedIndex(comboBoxDataList,this.systemUser.institutionCode);
					this.F601_63.dataProvider =comboBoxDataList;
					this.F601_63.selectedIndex =index;
				}else if(flag =="S301_10"){
					this.F601_64.dataProvider =comboBoxDataList;
					this.F601_64.selectedIndex =0;
				}
			
			}
			
			private function validate1():void
			{
				f601=new F601();
				var f601Request:F601Request=new F601Request();
				if(this.currentState=='pass')
				{
					if(CompMethod.validate('1',F601_62,'结果描述'))
						return ;
					if(CompMethod.validate('1',F601_64,'审核医生'))
						return ;
					
					f601.f60160=DateField.stringToDate(F601_60.text,'YYYY-MM-DD');
					f601.f60159='3';
					f601.f60161='1';
					f601.f60162=StringUtil.trim(F601_62.text);
					f601.f60163=F601_63.selectedItem.data;
					f601.f60164=StringUtil.trim(F601_62.text);
					
				}else
				{
					if(CompMethod.validate('1',F601_65,'退回描述'))
						return ;
					f601.f60159='4';
					f601.f60161='2';
					f601.f60165=StringUtil.trim(F601_65.text);
					f601.f60166=DateField.stringToDate(F601_66.text,'YYYY-MM-DD');
					
				}
					f601Request.f601=f601;
					f601Request.f60101List=f60101list;
					f601Service.renewF601(f601Request);
			}
			
			private function renewF601Handler(event:ResultEvent):void
			{
				var f601Response:Object = event.result;
				if(f601Response.state){
					Alert.show(f601Response.promptMessage, "系统提示",1,this,closeHandler);
					
				} else {
					Alert.show(f601Response.errorMessage, "系统提示");
				}
			}
			
			private function closeHandler(event:CloseEvent):void
			{
				if(event.detail==1)
				{
					var index:Object=this.owner;
					if(!checkMethod)
						index.refresh();
						
					this.removeWindow();
				}
			}
			
			protected function save_keyUpHandler(event:KeyboardEvent):void
			{
				if(event.keyCode==Keyboard.ENTER)
				{
					validate1();
				}
				
			}
			
		]]>
	</fx:Script>
	<s:states>
		<s:State name="pass" enterState="state1_enterStateHandler(event)"/>
		<s:State name="noPass"/>
	</s:states>
	<s:VGroup horizontalAlign="center" verticalAlign="middle">
		<s:VGroup includeIn="pass" width="100%" height="100%" chromeColor="#CCCCCC" paddingTop="5" paddingBottom="5">
			<mx:Grid>	
				<mx:GridRow paddingTop="5">
					<mx:GridItem paddingLeft="10" >
						<s:Label styleName="myLabel" text="结果描述：" />
					</mx:GridItem>
				</mx:GridRow>
				<mx:GridRow>
					<mx:GridItem paddingLeft="65" colSpan="3" paddingRight="10">
						<s:VGroup >
							<s:TextArea width="800" height="62" id="F601_62" text="无"/>
						</s:VGroup>
					</mx:GridItem>
				</mx:GridRow>
				<mx:GridRow paddingLeft="10">
					<mx:GridItem colSpan="3">
						<s:Label  styleName="myLabel" text="审核医生"/>						
						<component:FindSelectedItemComboBox editable="true" id="F601_64" width="130" height="22"/>
						<s:Label  styleName="myLabel" text="审核机构" paddingLeft="20"/>
						<s:DropDownList id="F601_63" width="130" enabled="false"/>
						
						
						<s:Label  styleName="myLabel" text="审核时间" paddingLeft="10"/>
						<mx:DateField yearNavigationEnabled="true" id="F601_60" width="140" dayNames='["周日","周一","周二","周三","周四","周五","周六"]'
									  monthNames='["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"]'
									  formatString="YYYY-MM-DD" editable="true" text="{DateField.dateToString(new Date(),'YYYY-MM-DD')}" 
									  restrict="0-9"
									  />
						
					</mx:GridItem>
				</mx:GridRow>
			</mx:Grid>
		</s:VGroup>
		<s:VGroup includeIn="noPass">
			<mx:Grid>	
				<mx:GridRow paddingTop="5">
					<mx:GridItem paddingLeft="10" colSpan="3">
						<s:Label styleName="myLabel" text="退回描述：" />
					</mx:GridItem>
				</mx:GridRow>
				<mx:GridRow>
					<mx:GridItem paddingLeft="75" colSpan="3" paddingRight="10">
						<s:VGroup >
							<s:TextArea width="800" height="62" id="F601_65" text="无"/>
						</s:VGroup>
					</mx:GridItem>
				</mx:GridRow>
				<mx:GridRow paddingLeft="10">
					<mx:GridItem >
						
						<s:Label  styleName="myLabel" text="退回时间" paddingLeft="10"/>
						<mx:DateField yearNavigationEnabled="true" id="F601_66" width="140" dayNames='["周日","周一","周二","周三","周四","周五","周六"]'
									  monthNames='["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"]'
									  formatString="YYYY-MM-DD" editable="true" text="{DateField.dateToString(new Date(),'YYYY-MM-DD')}" 
									  restrict="0-9"
									  />
						
					</mx:GridItem>
				</mx:GridRow>
			</mx:Grid>
		</s:VGroup>
		<s:HGroup paddingBottom="10" verticalAlign="middle" width="70%" horizontalAlign="center">
			<s:Button label="保存(Enter)" id="saveButton"  click="validate1()" chromeColor="#cccccc"/>
		</s:HGroup>
	</s:VGroup>
	
</s:TitleWindow>
