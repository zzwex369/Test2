<?xml version="1.0" encoding="utf-8"?>
<s:TitleWindow xmlns:fx="http://ns.adobe.com/mxml/2009"
			   xmlns:s="library://ns.adobe.com/flex/spark"
			   xmlns:mx="library://ns.adobe.com/flex/mx"
			   xmlns:component="com.xyw.sys.custom.component.*"
			   width="950"  borderAlpha="1.0" borderColor="#D5700D"
			   borderVisible="true" chromeColor="#5CACEE" close="closeHandler()"
			   cornerRadius="5"  title="两癌筛查任务数设置">
	<fx:Declarations>
		<s:RemoteObject id="systemService" destination="systemService"
						endpoint="{this.parentApplication.contextRoot}/messagebroker/amf"
						showBusyCursor="true">
			<s:method name="getComboBoxData" result="getComboBoxDataHandler(event)"/>	
		</s:RemoteObject>
			
		<s:RemoteObject id="l305Service" destination="l305Service"
						endpoint="{this.parentApplication.contextRoot}/messagebroker/amf"
						showBusyCursor="true">
			<s:method name="saveL305" result="saveL305Handler(event)"/>
		</s:RemoteObject>
	</fx:Declarations>
	<fx:Script>
		<![CDATA[
			import com.xyw.module.msss.la.model.L305;
			import com.xyw.sys.custom.component.CompMethod;
			import com.xyw.sys.model.ComboBoxDataRequest;
			import com.xyw.sys.model.SystemUser;
			
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.controls.DateField;
			import mx.events.CloseEvent;
			import mx.managers.PopUpManager;
			import mx.rpc.events.ResultEvent;
			import mx.utils.StringUtil;
			[Bindable]
			private var systemUser:SystemUser;
			private var comboBoxDataRequest:ComboBoxDataRequest;
			private function closeHandler():void
			{
				PopUpManager.removePopUp(this);
			}
			
			private function init():void
			{
				systemUser=this.parentApplication.systemUser;
				initializeComboBox();
			}
			
			private function _initializeComboBox(sql:String,flag:String,showPrompt:Boolean=true):void
			{
				comboBoxDataRequest = new ComboBoxDataRequest();
				comboBoxDataRequest.showPrompt = showPrompt;
				comboBoxDataRequest.sql = sql;
				comboBoxDataRequest.flag = flag;
				this.systemService.getComboBoxData(this.comboBoxDataRequest);
			}
			
			
			private function initializeComboBox():void
			{	
				_initializeComboBox("select t.d101_01, t.d101_02 from D101 t ","D101");
				
				_initializeComboBox("select t.s_01,t.s_02 from S301_10 t where t.S_05='1' and t.S_04 ="+this.systemUser.userCode,"S301_10",false);
				
			}
			
			/******************得到数据******************/
			private function getComboBoxDataHandler(event:ResultEvent):void
			{
				var comboBoxDataResponse:Object =  event.result;
				var flag:String = comboBoxDataResponse.flag;
				var comboBoxDataList:ArrayCollection = comboBoxDataResponse.comboBoxDataList;
				if(flag == "D101")
				{
					var index:int=CompMethod.getDropDownListSelectedIndex(comboBoxDataList,this.systemUser.institutionCode);
					L305_03.dataProvider =L305_07.dataProvider = comboBoxDataList;
					L305_03.selectedIndex=L305_07.selectedIndex=index;
				}else if(flag=="S301_10")
				{
					L305_10.dataProvider=comboBoxDataList;
					L305_10.selectedIndex=0;
				}
			}
			
			private function validate():void
			{
				if(!L305_02.value)
				{
					Alert.show("请输入正确的年份","系统提示");
					return;
				}
				if(CompMethod.validate('2',L305_03,'单位名称！'))
					return;
				if(CompMethod.validate('1',L305_05,'乳腺癌(任务数)！'))
					return;
				if(CompMethod.validate('1',L305_06,'宫颈癌(任务数)!'))
					return;
				if(CompMethod.validate('2',L305_07,'操作单位!'))
					return;
				if(CompMethod.validate('1',L305_10,'操作人员!'))
					return;
				if(CompMethod.validate('1',L305_11,'操作日期!'))
					return;
				saveL305();
			}
			
			private function saveL305():void
			{
				var l305:L305=new L305();
				l305.l30502=L305_02.value;
				l305.l30503=L305_03.selectedItem.label;
				l305.l30504=L305_03.selectedItem.data;
				l305.l30505=Number(StringUtil.trim(L305_05.text));
				l305.l30506=Number(StringUtil.trim(L305_06.text));
				l305.l30507=L305_07.selectedItem.label;
				l305.l30508=L305_07.selectedItem.data;
				l305.l30509=this.systemUser.institutionCode+'01';
				l305.l30510=StringUtil.trim(L305_10.text);
				l305.l30511=DateField.stringToDate(L305_11.text,'YYYY-MM-DD');
				l305.l30512=l305.l30511;
				l305Service.saveL305(l305);
			}
			
			private function saveL305Handler(event:ResultEvent):void
			{
				var l305Response:Object=event.result;
				if(l305Response.state)
				{
					Alert.show(l305Response.promptMessage,"系统提示",1,this,closeHandlerL305);
				}else
					Alert.show(l305Response.errorMessage,"系统提示");
			}
			
			private function closeHandlerL305(event:CloseEvent):void
			{
				if(event.detail==1)
				{
					var index:Object=this.owner;
					index.refresh();
					this.closeHandler();
				}
			}
		]]>
	</fx:Script>
	<s:Scroller  width="100%" height="100%" horizontalScrollPolicy="auto"
				 chromeColor="#cccccc" verticalScrollPolicy="auto">
		<s:VGroup horizontalAlign="center" paddingTop="10" creationComplete="init()">
			<mx:TabNavigator width="900" chromeColor="#ffffff" creationPolicy="all">
				<s:NavigatorContent width="100%" label="基本信息">	
					<mx:Grid paddingBottom="5">
						<mx:GridRow>
							<mx:GridItem>
								<s:Label styleName="myLabel"  text="设置年份" paddingLeft="5"/>
								<s:NumericStepper id="L305_02" width="130" maxChars="4" minimum="2018" maximum="2100"  value="{Number(DateField.dateToString(new Date(),'YYYY'))}" stepSize="1"/>
							</mx:GridItem>
							<mx:GridItem>
								<s:Label styleName="myLabel" text="单位名称"/><s:DropDownList id="L305_03" width="130"/>
							</mx:GridItem>
							<mx:GridItem>
								<s:Label styleName="myLabel" text="乳腺癌(任务数)"/>
								<s:TextInput id="L305_05" width="130" restrict="^a-z"/>
							</mx:GridItem>
							<mx:GridItem>
								<s:Label styleName="myLabel" text="宫颈癌(任务数)"/>
								<s:TextInput id="L305_06" width="130" restrict="^a-z"/>
							</mx:GridItem>
						</mx:GridRow>
						
						<mx:GridRow>
							<mx:GridItem>
								<s:Label styleName="myLabel" text="操作单位"  paddingLeft="5"/><s:DropDownList id="L305_07" width="130" mouseChildren="false"/>				
							</mx:GridItem>
							<mx:GridItem>
								<s:Label styleName="myLabel" text="操作人员"/><component:FindSelectedItemComboBox  height="21" editable="true" id="L305_10" width="130"/>
							</mx:GridItem>
							<mx:GridItem colSpan="2">
								<s:Label styleName="myLabel" text="操    作   时    间"/>
								
								<component:CustomRangeDateField  id="L305_11" isSelectNow="true"/>

							</mx:GridItem>
						</mx:GridRow>
					</mx:Grid>
				</s:NavigatorContent>
			</mx:TabNavigator>
			<s:HGroup width="900" height="30" contentBackgroundColor="#FF0000" horizontalAlign="center"
					  paddingBottom="20" paddingLeft="10" paddingTop="10" verticalAlign="middle">
				<s:Button id="save" label="保存" buttonMode="true" chromeColor="#CCCCCC" click="validate()"/>
			</s:HGroup>
		</s:VGroup>
	</s:Scroller>
</s:TitleWindow>
