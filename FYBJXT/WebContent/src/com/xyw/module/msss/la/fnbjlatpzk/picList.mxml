<?xml version="1.0" encoding="utf-8"?>
<s:List xmlns:fx="http://ns.adobe.com/mxml/2009"
		xmlns:s="library://ns.adobe.com/flex/spark"
		xmlns:mx="library://ns.adobe.com/flex/mx"
		skinClass="com.xyw.sys.custom.skin.CustomListSkin"
		width="{listWidth}" height="{listHeight}" click="itemClickHandler(event)"
		contentBackgroundColor="#FFFFFF" 
		itemRenderer="{new ClassFactory(CustomLaListColumnItemRenderer)}">
	
	<fx:Declarations>
		<s:RemoteObject id="l306Service" destination="l306Service"
						endpoint="{this.parentApplication.contextRoot}/messagebroker/amf"
						showBusyCursor="true">
		<!--	<s:method name="downPic" result="downPicHandler(event)"/>-->
			<s:method name="delByPicName" result="delByPicNameHandler(event)"/>
		</s:RemoteObject>
	</fx:Declarations>
	<fx:Metadata>
		[Event(name="downPicSuccess", type="flash.events.Event")]
	</fx:Metadata>
	<fx:Script>
		<![CDATA[
			import com.xyw.module.msss.la.model.L306;
			import com.xyw.module.msss.la.model.L306Request;
			import com.xyw.module.msss.la.model.VL306;
			import com.xyw.sys.custom.component.CompMethod;
			import com.xyw.sys.custom.component.ImageWindow;
			import com.xyw.sys.custom.itemrenderer.CustomLaListColumnItemRenderer;
			import com.xyw.sys.custom.skin.CustomTitleWindowSkin;
			
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.core.FlexGlobals;
			import mx.events.CloseEvent;
			import mx.managers.PopUpManager;
			import mx.rpc.events.ResultEvent;
			
			import spark.components.Label;
			[Bindable]
			public var listWidth:Object="100%";
			[Bindable]
			public var listHeight:Object="100%";
			[Bindable]
			public var colCount:Number;
			[Bindable]
			public var rowCount:Number=2;
			private var loader:Loader;
			private var bitmapData:BitmapData; 
			private var selectFile:Object;//选中的图片
			private var l306:L306;
			private var l306Request:L306Request;
			private var imgUrlPrefix:String="http://61.158.252.68";
			private var imgUrlSuffix:String="/cs_csyxzmweb/FYBJ_csscbg_picture/41130200000005/83CC9F2E51DE6301E050007F01007182/02/蒋娟(CLR_0)1552286415988.jpg";
			private var picArr:ArrayCollection=new ArrayCollection();//图片集合
			[Bindable]
			public var picTypeArr:Array;//图片类型  1 阴道镜  2超声 3x线
			
			/** 
			 * 显示选中条目的详细信息 
			 */  
			private function itemClickHandler(event:MouseEvent):void  
			{   
				if(this.dataProvider)
					selectFile=this.selectedItem;
				if(event.target is Label)
				{
					var label:Label=Label(event.target);
					if(label.text=="查看原图")
						smallerimg(null);
					if(label.text=="删除")
						deletePic();
				}
			} 
			
			
			/**
			 *下载二进制图片
			 */
			public function downPicData(vl306s:ArrayCollection,picType:String,delStaus:Boolean=false):void
			{
				for(var i:int=0;i<vl306s.length;i++)
				{
					var picNum:Number=0;
					var vl306:Object=vl306s.getItemAt(i);
					var j:int=picType=='1'?9:11;
					for(var k:int=5;k<j;k++)
					{
						var length:Number=k.toString().length;
						var suffix:String=length>1?k.toString():"0"+k;
						var field:String="l306"+suffix;	
						if(vl306[field])
						{
							/* l306=new L306();
							l306.l30601=vl306.l30601;
							l306Request=new L306Request();
							l306Request.l306=l306;
							l306Request.flag=picType;
							l306Request.suffix=suffix;
							l306Request.picPath=vl306[field];
							l306Request.picNum=(++picNum).toString();
							l306Request.delStatus=(delStaus&&vl306.l30641=="2")?delStaus:false;
							l306Service.downPic(l306Request); */
							var index:Number=Number(picType)-1;
							var data:Object=new Object();
							data.l30601=vl306.l30601;
							//data.data=imgUrlPrefix+imgUrlSuffix;
							data.data=imgUrlPrefix+vl306[field];
							data.suffix=suffix;
							data.picType=picType;
							data.picNum=(++picNum).toString();
							data.picPath=imgUrlSuffix;
							data.delStatus=(delStaus&&vl306.l30641=="2")?delStaus:false;
							picArr.addItem(data);
							this.dataProvider=picArr;
							this.dispatchEvent(new Event("downPicSuccess"));
						}
					}
				}
			}
			/**
			 *返回图片二进制
			 */
			private function downPicHandler(event:ResultEvent):void
			{
				var l306Response:Object = event.result;
				if(l306Response.status)
				{
					var index:Number=Number(l306Response.flag)-1;
					var data:Object=new Object();
					data.l30601=l306Response.l30601;
					data.data=l306Response.imageByte;
					data.suffix=l306Response.suffix;
					data.picType=l306Response.flag;
					data.picNum=l306Response.picNum;
					data.picPath=l306Response.picPath;
					data.delStatus=l306Response.delStatus;
					picArr.addItem(data);
					this.dataProvider=picArr;
					this.dispatchEvent(new Event("downPicSuccess"));
				}
			}
			
			
			/**
			 *删除选中图片
			 */
			private function deletePic():void
			{
				if(!selectFile){
					Alert.show("请选择删除的图片");
					return ;
				}
				Alert.show("是否要删除选中的图片！","系统提示",3,this,delHandler);	
			}
			
			/**
			 *
			 */
			private function delHandler(event:CloseEvent):void
			{
				if(event.detail==1)
				{
					l306=new L306();
					l306Request=new L306Request();
					l306.l30601=selectFile.l30601;
					l306.l30604=selectFile.picType;
					l306Request.suffix=selectFile.suffix;
					l306Request.picPath=selectFile.picPath;
					l306Request.l306=l306;
					l306Service.delByPicName(l306Request);
				}	
			}
			
			/**
			 *删除返回信息 并处理删除前台图片
			 */
			private function delByPicNameHandler(event:ResultEvent):void
			{
				var l306Response:Object = event.result;
				if(l306Response.status)
				{
					var index:Number=this.selectedIndex;
					var array:Vector.<int>=this.selectedIndices;  
					var listArr:ArrayCollection=ArrayCollection(this.dataProvider);
					if(array.length>0){  
						array.sort(Array.NUMERIC);//按数字升序排序   
						for(var i:int=0;i<array.length;i++)  
						{  
							listArr.removeItemAt(array[i]-i);//从待上传列表中移出  
						} 
						if(listArr.length)
						{
							var obj:Object=listArr.getItemAt((listArr.length>>1));	
							if(Number(obj.picNum)>(index+1))
							{
								for(var j:Number=index;j<listArr.length;j++){	
									obj=listArr.getItemAt(j);
									obj.picNum=j+1;
									listArr[j]=obj;		
								}
							}
						}
					}
					this.selectedItem=selectFile=null;
				}else
					Alert.show(l306Response.errorMessage,"系统提示");
			}
			
			
			/**
			 * 预览图片
			 */
			private function smallerimg(event:MouseEvent):void
			{
				var imgwindow:ImageWindow = new ImageWindow();
				imgwindow.imageSource=this.selectFile.data;
				CompMethod.popUpTitleWindow(imgwindow,this,true);
				/* if(loader)
					loader=null;
				loader = new Loader();
				loader.contentLoaderInfo.addEventListener(Event.COMPLETE,loaderCompleteHandler); 
				loader.loadBytes(this.selectFile.data); */
			}
			
			/**
			 * 得到图片的字符数组并将其转换为图片
			 */
			private function loaderCompleteHandler(e:Event):void   
			{   
				var bitmap:Bitmap = Bitmap(loader.content);   
				bitmapData = bitmap.bitmapData;
				var imgwindow:ImageWindow = new ImageWindow();
    			CompMethod.popUpTitleWindow(imgwindow,this,true);	
				imgwindow.imageSource= new Bitmap(bitmapData,"auto",true);
				imgwindow.init();
			}   
			
		]]>
	</fx:Script>
	
		<s:layout>
			<s:TileLayout requestedColumnCount="{colCount}" requestedRowCount="{rowCount}"/>
		</s:layout>
	</s:List>