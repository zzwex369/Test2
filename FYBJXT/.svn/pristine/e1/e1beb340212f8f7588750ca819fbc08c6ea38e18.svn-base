<?xml version="1.0" encoding="utf-8"?>
<s:TitleWindow xmlns:fx="http://ns.adobe.com/mxml/2009" 
			   xmlns:s="library://ns.adobe.com/flex/spark" 
			   xmlns:mx="library://ns.adobe.com/flex/mx" 
			   xmlns:component = "com.xyw.sys.custom.component.*"
			   title="宫颈癌档案修改"
			   width="1200"  cornerRadius="5" 
			   backgroundColor="white" chromeColor="#5CACEE" 
			   close="CompMethod.closeWindow(this)"
			   creationComplete="init()">
	<fx:Declarations>
		<s:RemoteObject id="systemService" destination="systemService"
						endpoint="{this.parentApplication.contextRoot}/messagebroker/amf"
						showBusyCursor="true">
			<s:method name="getComboBoxData" result="getComboBoxDataHandler(event)"/>
		</s:RemoteObject>
		<s:RemoteObject id="l301Service" destination="l301Service"
						endpoint="{this.parentApplication.contextRoot}/messagebroker/amf"
						showBusyCursor="true">
			<s:method name="renewL301" result="renewL301Handler(event)"/>
		</s:RemoteObject>
	</fx:Declarations>
	
	<fx:Script>
		<![CDATA[
			import com.xyw.module.msss.la.model.L301;
			import com.xyw.module.msss.la.model.L301Request;
			import com.xyw.module.msss.la.model.VL301;
			import com.xyw.sys.custom.component.CompMethod;
			import com.xyw.sys.model.ComboBoxDataRequest;
			import com.xyw.sys.model.SystemUser;
			
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.controls.DateField;
			import mx.events.CloseEvent;
			import mx.events.FlexEvent;
			import mx.managers.PopUpManager;
			import mx.rpc.events.ResultEvent;
			import mx.utils.StringUtil;
			
			import spark.components.RadioButton;
			public var vl301:Object;
			[Bindable]
			private var systemUser:SystemUser;
			private var comboBoxDataRequest:ComboBoxDataRequest;
			private var i:int=0;
			private var count:uint=7;
			private var patternMonther:RegExp = /^(\d{18,18}|\d{15,15}|\d{17,17}X|\d{17,17}x)$/g;

			private function init():void
			{
				systemUser=this.parentApplication.systemUser;
				var date:Date=new Date();
				L301_19.selectedDate=date;
				initializeComboBox();
			}
			
			private function _initializeComboBox(sql:String,flag:String,showPrompt:Boolean=true):void
			{
				comboBoxDataRequest = new ComboBoxDataRequest();
				comboBoxDataRequest.showPrompt = showPrompt;
				comboBoxDataRequest.sql = sql;
				comboBoxDataRequest.flag = flag;
				this.systemService.getComboBoxData(this.comboBoxDataRequest);
			}
			
			/******************下拉框填充数据******************/
			private function initializeComboBox():void
			{
				
				_initializeComboBox("select t.d101_01, t.d101_02 from D101 t where t.D101_01 = " + this.systemUser.institutionCode + " or t.D101_11 = " + this.systemUser.institutionCode,"D101",false);
				
				_initializeComboBox("select * from  S301_03 t","S301_03");
				
				_initializeComboBox("select * from  S301_04 t","S301_04");
				
				_initializeComboBox("select * from  S301_06 t","S301_06");

				_initializeComboBox("select * from  S601_04 t","S601_04",false);
				
				_initializeComboBox("select * from  LA301_01 t","LA301_01",false);
				
				_initializeComboBox("select * from  LA301_02 t","LA301_02",false);
		
				
			}
			/******************得到数据******************/
			private function getComboBoxDataHandler(event:ResultEvent):void
			{
				var comboBoxDataResponse:Object =  event.result;
				var flag:String = comboBoxDataResponse.flag;
				var comboBoxDataList:ArrayCollection = comboBoxDataResponse.comboBoxDataList;
				if(flag == "D101")
				{
					L301_17.dataProvider = comboBoxDataList;
				}else if(flag=="S301_03")
				{
					L301_08.dataProvider=comboBoxDataList;
				}else if(flag=="S301_04")
				{
					L301_07.dataProvider=comboBoxDataList;
				}else if(flag=="S301_06")
				{
					L301_03.dataProvider=comboBoxDataList;
				}else if(flag=="S601_04")
				{
					L301_25.dataProvider=comboBoxDataList;
				}else if(flag=="LA301_01")
				{
					L301_09.dataProvider=comboBoxDataList;
				}else if(flag=="LA301_02")
				{
					L301_26.dataProvider=comboBoxDataList;
				}
				--count;
				if(!count)
					putVL301();
			}
			private function readCard():void
			{
				var arr:Array=CompMethod.readCard();
				if(arr!=null)
				{
					var boolean:Boolean=CompMethod.sex("女",arr[1]);
					if(boolean)
					{
						L301_02.text=arr[0];
						L301_04.text=arr[5];
						L301_06.text=CompMethod.getAge(arr[5]);
						L301_05.text=arr[3];
						L301_07.selectedIndex=CompMethod.getDropDownListSelectedIndex(ArrayCollection(L301_07.dataProvider),arr[2],true);
						L301_12.text=arr[4];
						if(!L301_03.selectedIndex)
							L301_03.selectedIndex=1;
					}
				}else
				{					
					Alert.show("读卡失败","系统提示");
				}
			}
			private function putVL301():void
			{
				
				L301_02.text=vl301.l30102;
				L301_04.text=vl301.l30104;
				L301_12.text=vl301.l30112;
				L301_18.text=vl301.l30118;
				L301_10.text=vl301.l30110;
				L301_06.text=String(vl301.l30106);
				setRadioButtonValue(L301_27,vl301.l30127);
				setRadioButtonValue(L301_29,vl301.l30129);
				setRadioButtonValue(L301_30,vl301.l30130);
				L301_05.text=DateField.dateToString(vl301.l30105,'YYYY-MM-DD');
				L301_19.text=DateField.dateToString(vl301.l30119,'YYYY-MM-DD');
				L301_03.selectedIndex=CompMethod.getDropDownListSelectedIndex(ArrayCollection(L301_03.dataProvider),vl301.l30103);
				L301_07.selectedIndex=CompMethod.getDropDownListSelectedIndex(ArrayCollection(L301_07.dataProvider),vl301.l30107);
				L301_08.selectedIndex=CompMethod.getDropDownListSelectedIndex(ArrayCollection(L301_08.dataProvider),vl301.l30108);
				L301_09.selectedIndex=CompMethod.getDropDownListSelectedIndex(ArrayCollection(L301_09.dataProvider),vl301.l30109);
				L301_17.selectedIndex=CompMethod.getDropDownListSelectedIndex(ArrayCollection(L301_17.dataProvider),vl301.l30117);
				L301_25.selectedIndex=CompMethod.getDropDownListSelectedIndex(ArrayCollection(L301_25.dataProvider),vl301.l30125);
				L301_26.selectedIndex=CompMethod.getDropDownListSelectedIndex(ArrayCollection(L301_26.dataProvider),vl301.l30126);
			}
			
			/*******************验证*****************/
			private function saveL301(event:MouseEvent):void
			{
				//save.enabled=false;
				if(StringUtil.trim(L301_02.text)=="")
				{
					Alert.show("请输入姓名","系统提示");
					return;
				}
				if(L301_03.selectedIndex==0)
				{
					Alert.show("请选择证件类型","系统提示");
					return;
				}
				if(StringUtil.trim(L301_04.text)=="")
				{
					Alert.show("请输入证件号码","系统提示");
					return ;
				}
				if(L301_03.selectedIndex==1)
				{
					if(!patternMonther.test(StringUtil.trim(L301_04.text)))
					{
						Alert.show("身份证号码有误!","系统提示");
						return;
					}
					
				}
				if(StringUtil.trim(L301_05.text)=="")
				{
					Alert.show("请选择出生日期","系统提示");
					return ;
				}
				if(StringUtil.trim(L301_06.text)=="")
				{
					Alert.show("请输入年龄","系统提示");
					return ;
				}
				var age:Number=Number(StringUtil.trim(L301_06.text));
				if(age<35||age>64)
				{
					Alert.show("年龄必须在35岁至64岁之间才能登记档案信息","系统提示");
					return ;
				}
				if(L301_07.selectedIndex==0)
				{
					Alert.show("请选择民族","系统提示");
					return ;
				}
				if(L301_09.selectedIndex==0)
				{
					Alert.show("请选择文化程度","系统提示");
					return ;
				}
				if(StringUtil.trim(L301_10.text)=="")
				{
					Alert.show("请输入联系方式","系统提示");
					return ;
				}
				if(!CompMethod.validateAreaCode(L301_11.getAreaCode(),"",true))
				{
					Alert.show("户口地址请选择到乡镇","系统提示");
					return ;
				}

				if(StringUtil.trim(L301_18.text)=="")
				{
					Alert.show("请输入录入人员信息","系统提示");
					return ;
				}
				_save();
			}
			
			private function _save():void
			{
				save.enabled=false;
				var l301:L301=new L301();
				var l301Request:L301Request=new L301Request();
				l301.l30101=vl301.l30101;
				l301.l30114=vl301.l30114;
				l301.l30115=vl301.l30115;
				l301.l30116=vl301.l30116;
				l301.l30133=vl301.l30133;
				l301.l30134=vl301.l30134;
				l301.l30102=StringUtil.trim(L301_02.text);
				l301.l30103=L301_03.selectedItem.data;
				l301.l30104=StringUtil.trim(L301_04.text);
				l301.l30105=DateField.stringToDate(L301_05.text,"YYYY-MM-DD");
				l301.l30106=Number(StringUtil.trim(L301_06.text));
				l301.l30107=L301_07.selectedItem.data;
				l301.l30108=L301_08.selectedItem.data;
				l301.l30109=L301_09.selectedItem.data;
				l301.l30110=StringUtil.trim(L301_10.text);
				l301.l30111=L301_11.getAreaCode();
				l301.l30112=StringUtil.trim(L301_12.text);
				l301.l30113=L301_13.getAreaCode();
				l301.l30117=L301_17.selectedItem.data;
				l301.l30125=L301_25.selectedItem.data;
				l301.l30126=L301_26.selectedItem.data;
				l301.l30118=StringUtil.trim(L301_18.text);
				l301.l30127=getRadioButtonValue(L301_27);
				l301.l30129=getRadioButtonValue(L301_29);
				l301.l30130=getRadioButtonValue(L301_30);
				l301.l30119=DateField.stringToDate(L301_19.text,"YYYY-MM-DD");
				l301.l30124=L301_17.selectedItem.label;
				l301.l30120=l301.l30117+'01';
				l301.l30121=l301.l30119;
				l301.l30122=vl301.l30122;
				l301.l30128=vl301.l30128;
				l301.l30131=vl301.l30131;
				l301.l30132=vl301.l30132;
				l301Request.l301=l301;
				l301Service.renewL301(l301Request);
			}
			private function renewL301Handler(event:ResultEvent):void
			{
				var l301Response:Object=event.result;
				if(l301Response.state)
				{
					Alert.show(l301Response.promptMessage,"系统提示",1,this,closeHandlerL301);
				}else
				{
					Alert.show(l301Response.errorMessage,"系统提示");
					save.enabled=true;				
				}
			}
			
			private function closeHandlerL301(event:CloseEvent):void
			{
				if(event.detail)
				{
					var index:Object=this.owner;
					index.refresh();
					CompMethod.closeWindow(this);
				}
			}
			
			private function L301_11_creationCompleteHandler(event:FlexEvent):void
			{
				 if(vl301!=null)
					L301_11.setAreaCode(vl301.l30111); 
			}
			
			private function L301_13_creationCompleteHandler(event:FlexEvent):void
			{
				 if(vl301!=null)
					L301_13.setAreaCode(vl301.l30113);	 
			}
			
			private function setAge():void
			{
				if(L301_03.selectedIndex==1&&StringUtil.trim(L301_04.text).length>= 16)
				{
					L301_06.text=CompMethod.getAge(StringUtil.trim(L301_04.text));
					L301_05.text=CompMethod.getBirthday(StringUtil.trim(L301_04.text));
					if(StringUtil.trim(L301_05.text)!="")
						L301_05.text=DateField.dateToString(DateField.stringToDate(L301_05.text,'YYYY-MM-DD'),'YYYY-MM-DD');
				}
			}
			
			/**
			 *得到单选框值
			 */
			private function getRadioButtonValue(id:Object):String
			{
				var value:String;
				var radioButton:RadioButton;
				for(var i:int=0;i<id.numElements;i++)
				{
					radioButton=id.getElementAt(i) as RadioButton;
					if(radioButton.selected)
						value=radioButton.value.toString();
				}
				return value;
			}
			
			/**
			 *设置单选框
			 */
			private function setRadioButtonValue(id:Object,value:String):void
			{
				var i:int=Number(StringUtil.trim(value))-1;
				(id.getElementAt(i) as RadioButton).selected=true;
			}
		]]>
	</fx:Script>
	<s:Scroller x="-6" y="1" width="100%" height="100%" horizontalScrollPolicy="auto"
				verticalScrollPolicy="auto">
		<s:VGroup paddingBottom="20" paddingLeft="10" paddingRight="10" paddingTop="10">
			<s:VGroup id="djVGroup">
				<mx:TabNavigator width="1150" chromeColor="#ffffff" creationPolicy="all">
					<s:NavigatorContent width="100%" label="基本信息">			
						<mx:Grid>
							<mx:GridRow>
								<mx:GridItem>
									<s:Label styleName="myLabel pf10"  text="姓           名" />
								</mx:GridItem>
								<mx:GridItem>
									<s:TextInput id="L301_02" width="130" restrict="^0-9"/>
								</mx:GridItem>
								<mx:GridItem>
									<s:Label styleName="myLabel" text="证件类型"/>
								</mx:GridItem>
								<mx:GridItem>
									<s:DropDownList width="130" id="L301_03"/>
								</mx:GridItem>
								<mx:GridItem>
									<s:Label styleName="myLabel" text="证 件 号 码" />
								</mx:GridItem>
								<mx:GridItem>
									<s:TextInput id="L301_04" width="140" restrict="0-9X" change="setAge()"/>
								</mx:GridItem>
								<mx:GridItem>
									<s:Label styleName="myLabel" text="年          龄"/>
								</mx:GridItem>
								<mx:GridItem>
									<s:TextInput id="L301_06" width="130" restrict="0-9" maxChars="2"/>
								</mx:GridItem>
								<mx:GridItem>
									<s:Label styleName="myLabel" text="出生日期"/>
								</mx:GridItem>
								<mx:GridItem>
									
									<component:CustomRangeDateField  id="L301_05" isQuerySysDate="false"/>

									<s:Button label="读卡" buttonMode="true" enabled="{systemUser.duka=='1'}" click="readCard()"/>
								</mx:GridItem>
							</mx:GridRow>
							<mx:GridRow>
								<mx:GridItem>
									<s:Label styleName="myLabel pf10" text="民           族"/>
								</mx:GridItem>
								<mx:GridItem>
									<s:DropDownList width="130" id="L301_07"/>
								</mx:GridItem>
								<mx:GridItem>
									<s:Label styleName="myLabel" text="国      籍"/>
								</mx:GridItem>
								<mx:GridItem>
									<s:DropDownList width="130" id="L301_08"/>

								</mx:GridItem>
								<mx:GridItem >
									<s:Label styleName="myLabel" text="身份证地址"/>
								</mx:GridItem>
								<mx:GridItem colSpan="3">
									<s:TextInput id="L301_12" width="360"/>
								</mx:GridItem>
								<mx:GridItem >
									<s:Label styleName="myLabel" text="联系方式"/>
								</mx:GridItem>
								<mx:GridItem >
									<s:TextInput id="L301_10" width="130" restrict="0-9"/>
								</mx:GridItem>
							</mx:GridRow>
							
							<mx:GridRow>
								
								<mx:GridItem>
									<s:Label styleName="myLabel pf10" text="职           业"/>
								</mx:GridItem>
								<mx:GridItem >
									<s:DropDownList width="130" id="L301_26"/>
								</mx:GridItem>
								<mx:GridItem>
									<s:Label styleName="myLabel pf10" text="文化程度"/>
								</mx:GridItem>
								<mx:GridItem >
									<s:DropDownList width="130" id="L301_09"/>
								</mx:GridItem>
							
								
								<mx:GridItem>
									<s:Label styleName="myLabel pf10" text="自愿免费检查"/>
								</mx:GridItem>
								
								<mx:GridItem >
									<s:DropDownList width="130" id="L301_25"/>
								</mx:GridItem>
								
								<mx:GridItem>
									<s:Label styleName="myLabel pf10" text="户口类别"/>
								</mx:GridItem>
								
								<mx:GridItem colSpan="3">
									<s:HGroup gap="40" id="L301_27">
										<s:RadioButton groupName="L301_27" value="1" label="本县区" buttonMode="true"/>
										<s:RadioButton groupName="L301_27" value="2" label="本市" buttonMode="true"/>
										<s:RadioButton groupName="L301_27" value="3" label="本省外市" buttonMode="true"/>
										<s:RadioButton groupName="L301_27" value="4" label="外省" buttonMode="true"/>
									</s:HGroup>
								</mx:GridItem>
								
								
								
								
							</mx:GridRow>
								
							<mx:GridRow>
								
								<mx:GridItem>
									<s:Label styleName="myLabel pf10" text="建卡贫困户"/>
								</mx:GridItem>
								
								<mx:GridItem>
									<s:HGroup gap="40" id="L301_29">
										<s:RadioButton groupName="L301_29" value="1" label="是" buttonMode="true"/>
										<s:RadioButton groupName="L301_29" value="2" label="否" buttonMode="true"/>
									</s:HGroup>
								</mx:GridItem>
								
								<mx:GridItem>
									<s:Label styleName="myLabel pf10" text="城市低保"/>
								</mx:GridItem>
								
								<mx:GridItem>
									<s:HGroup gap="40" id="L301_30">
										<s:RadioButton groupName="L301_30" value="1" label="是" buttonMode="true"/>
										<s:RadioButton groupName="L301_30" value="2" label="否" buttonMode="true"/>
									</s:HGroup>
								</mx:GridItem>
								
							</mx:GridRow>
							<mx:GridRow>
								<mx:GridItem >
									<s:Label styleName="myLabel pf10" text="现住址"/>
								</mx:GridItem>
								<mx:GridItem colSpan="9">
									<component:AreaComboBoxVillageAuto id="L301_13" width="844" buttonMode="true" mouseChildren="false"
																	   table="D201_MS" areaCode="4113"
																	   creationComplete="L301_13_creationCompleteHandler(event)"/>
									
								</mx:GridItem>
							</mx:GridRow>
							
							<mx:GridRow paddingBottom="10">
								<mx:GridItem  >
									<s:Label styleName="myLabel pf10"  text="户口地址"/>
								</mx:GridItem>
								<mx:GridItem colSpan="9">
									<component:AreaComboBoxVillageAuto id="L301_11" width="844" buttonMode="true" 
																	   table="D201_MS" areaCode="4113"
																	   creationComplete="L301_11_creationCompleteHandler(event)"/>
									
								</mx:GridItem>
							</mx:GridRow>
							
						
						</mx:Grid>
					</s:NavigatorContent>
				</mx:TabNavigator>
				<mx:TabNavigator width="1150" chromeColor="#ffffff" creationPolicy="all">
					<s:NavigatorContent width="100%" label="录入信息">			
						<s:VGroup paddingBottom="2" paddingLeft="10" paddingRight="10">	
							<s:HGroup width="100%" height="100%" paddingBottom="5" verticalAlign="middle">
								<s:Label  text="录入单位"/><s:DropDownList width="130" id="L301_17" mouseChildren="false"/>
								<s:Label  text="录入人员"/><s:TextInput width="130" id="L301_18"/>
								<s:Label  text="录入时间"/>
								<component:CustomRangeDateField  id="L301_19" isQuerySysDate="false" enabled="false"/>

							</s:HGroup>
						</s:VGroup>
					</s:NavigatorContent>
				</mx:TabNavigator>
				<s:HGroup width="1150" height="30" contentBackgroundColor="#FF0000" horizontalAlign="center"
						  paddingBottom="20" paddingLeft="10" paddingTop="10" verticalAlign="middle">
					<s:Button id="save" label="保存" buttonMode="true" chromeColor="#CCCCCC" click="saveL301(event)"/>
				</s:HGroup>
			</s:VGroup>
		</s:VGroup>
	</s:Scroller>
</s:TitleWindow>
