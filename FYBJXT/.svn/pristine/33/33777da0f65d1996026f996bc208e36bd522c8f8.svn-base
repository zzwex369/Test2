<?xml version="1.0" encoding="utf-8"?>
<s:TitleWindow xmlns:fx="http://ns.adobe.com/mxml/2009" 
			   xmlns:s="library://ns.adobe.com/flex/spark" 
			   xmlns:mx="library://ns.adobe.com/flex/mx" 
			   title="标本审核" backgroundColor="#FFFFFF"
			   chromeColor="#5CACEE"  cornerRadius="5"
			   close="removeWindow()"
			   xmlns:component="com.xyw.sys.custom.component.*"
			   creationComplete="creationCompleteHandler(event)">
	<fx:Declarations>
		<s:RemoteObject id="e601Service" destination="e601Service" endpoint="{this.parentApplication.contextRoot}/messagebroker/amf" showBusyCursor="true">
			<s:method name="renewE601" result="renewE601Handler(event)"/>
		</s:RemoteObject>
		
		<s:RemoteObject id="systemService" destination="systemService" endpoint="{this.parentApplication.contextRoot}/messagebroker/amf" showBusyCursor="true">
			<s:method name="getComboBoxData" result="getComboBoxDataHandler(event)"/>
		</s:RemoteObject>
	</fx:Declarations>
	<fx:Style>
		@namespace s "library://ns.adobe.com/flex/spark";
		.myLabel {
			fontSize:12px;
			paddingTop:4px;
		}
	</fx:Style>
	<fx:Script>
		<![CDATA[
			import com.xyw.module.msss.etbj.model.E601;
			import com.xyw.module.msss.etbj.model.E601Request;
			import com.xyw.sys.custom.component.CompMethod;
			import com.xyw.sys.model.ComboBoxDataRequest;
			import com.xyw.sys.model.SystemUser;
			
			import mx.accessibility.DateFieldAccImpl;
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.events.CloseEvent;
			import mx.events.FlexEvent;
			import mx.managers.PopUpManager;
			import mx.rpc.events.ResultEvent;
			import mx.utils.StringUtil;
			private var comboBoxDataRequest:ComboBoxDataRequest;
			public var systemUser:SystemUser =null;
			public var state:String='';
			public var itemArr:ArrayCollection=null;
			private var e60101list:ArrayCollection=null;
			private var e601:E601=null;
			protected function creationCompleteHandler(event:FlexEvent):void
			{
				this.currentState=state;
				if(itemArr)
				{
					e60101list=new ArrayCollection();
					for(var i:int=0;i<itemArr.length;i++)
					{
						var ve601:Object=itemArr.getItemAt(i);
						e60101list.addItem(ve601.e60101);
					}
				}
				
			}
			
			private function removeWindow():void
			{
				PopUpManager.removePopUp(this);
			}
			
			protected function state1_enterStateHandler(event:FlexEvent):void
			{
				this.systemUser =this.parentApplication.systemUser;
				
				comboBoxDataRequest =new ComboBoxDataRequest();
				comboBoxDataRequest.showPrompt =false;
				comboBoxDataRequest.flag ="D101";
				comboBoxDataRequest.sql ="select t.d101_01, t.d101_02 from D101 t where t.d101_01 = '" + this.systemUser.institutionCode + "' or t.d101_11 ='" + this.systemUser.institutionCode +"'";
				this.systemService.getComboBoxData(this.comboBoxDataRequest);
				
			}
			
			private function getComboBoxDataHandler(event:ResultEvent):void
			{
				var comboBoxDataResponse:Object =event.result;
				var flag:String =comboBoxDataResponse.flag;
				var comboBoxDataList:ArrayCollection =comboBoxDataResponse.comboBoxDataList;
				
				if(flag =="D101"){
					var index:int =CompMethod.getDropDownListSelectedIndex(comboBoxDataList,this.systemUser.institutionCode);
					this.E601_42.dataProvider =comboBoxDataList;
					this.E601_42.selectedIndex =index;
				
				}
			
			}
			
			private function validate1():void
			{
				e601=new E601();
				var e601Request:E601Request=new E601Request();
				if(this.currentState=='pass')
				{
					if(CompMethod.validate('1',E601_41,'结果描述'))
						return ;
					if(CompMethod.validate('1',E601_43,'审核医生'))
						return ;
					
					e601.e60139=DateField.stringToDate(E601_39.text,'YYYY-MM-DD');
					e601.e60136='3';
					e601.e60140='1';
					e601.e60141=StringUtil.trim(E601_41.text);
					e601.e60142=E601_42.selectedItem.data;
					e601.e60143=StringUtil.trim(E601_43.text);
				
				
					
				}else
				{
					if(CompMethod.validate('1',E601_44,'退回描述'))
						return ;
					e601.e60136='4';
					e601.e60140='0';
					e601.e60144=StringUtil.trim(E601_44.text);
					e601.e60145=DateField.stringToDate(E601_45.text,'YYYY-MM-DD');
				}
				e601Request.e601=e601;
				e601Request.e60101List=e60101list;
				e601Service.renewE601(e601Request);
			}
			
			private function renewE601Handler(event:ResultEvent):void
			{
				var f601Response:Object = event.result;
				if(f601Response.state){
					Alert.show(f601Response.promptMessage, "系统提示",1,this,closeHandler);
					
				} else {
					Alert.show(f601Response.errorMessage, "系统提示");
				}
			}
			
			private function closeHandler(event:CloseEvent):void
			{
				if(event.detail==1)
				{
					var index:Object=this.owner;
					index.refresh();
					this.removeWindow();
				}
			}
			
		]]>
	</fx:Script>
	<s:states>
		<s:State name="pass" enterState="state1_enterStateHandler(event)"/>
		<s:State name="noPass"/>
	</s:states>
	<s:VGroup horizontalAlign="center" verticalAlign="middle">
		<s:VGroup includeIn="pass" width="100%" height="100%" chromeColor="#CCCCCC" paddingTop="5" paddingBottom="5">
			<mx:Grid>	
				<mx:GridRow paddingTop="5">
					<mx:GridItem paddingLeft="10" >
						<s:Label styleName="myLabel" text="结果描述：" />
					</mx:GridItem>
				</mx:GridRow>
				<mx:GridRow>
					<mx:GridItem paddingLeft="65" colSpan="3" paddingRight="10">
						<s:VGroup >
							<s:TextArea width="800" height="62" id="E601_41" />
						</s:VGroup>
					</mx:GridItem>
				</mx:GridRow>
				<mx:GridRow paddingLeft="10">
					<mx:GridItem colSpan="3">
						<s:Label  styleName="myLabel" text="审核医生"/>
						<s:TextInput id="E601_43" width="130" />
						
						<s:Label  styleName="myLabel" text="审核机构" paddingLeft="20"/>
						<s:DropDownList id="E601_42" width="130" enabled="false"/>
						
						
						<s:Label  styleName="myLabel" text="审核时间" paddingLeft="10"/>
						
						<component:CustomRangeDateField id="E601_39" isSelectNow="true" width="130" enabled="false"/>

						
					</mx:GridItem>
				</mx:GridRow>
			</mx:Grid>
		</s:VGroup>
		<s:VGroup includeIn="noPass">
			<mx:Grid>	
				<mx:GridRow paddingTop="5">
					<mx:GridItem paddingLeft="10" colSpan="3">
						<s:Label styleName="myLabel" text="退回描述：" />
					</mx:GridItem>
				</mx:GridRow>
				<mx:GridRow>
					<mx:GridItem paddingLeft="75" colSpan="3" paddingRight="10">
						<s:VGroup >
							<s:TextArea width="800" height="62" id="E601_44" />
						</s:VGroup>
					</mx:GridItem>
				</mx:GridRow>
				<mx:GridRow paddingLeft="10">
					<mx:GridItem >
						
						<s:Label  styleName="myLabel" text="退回时间" paddingLeft="10"/>
						<mx:DateField yearNavigationEnabled="true" id="E601_45" width="140" dayNames='["周日","周一","周二","周三","周四","周五","周六"]'
									  monthNames='["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"]'
									  formatString="YYYY-MM-DD" editable="true" text="{DateField.dateToString(new Date(),'YYYY-MM-DD')}" 
									  restrict="0-9"
									  />
						
					</mx:GridItem>
				</mx:GridRow>
			</mx:Grid>
		</s:VGroup>
		<s:HGroup paddingBottom="10" verticalAlign="middle" width="100%" horizontalAlign="center">
			<s:Button label="保存" id="saveButton" click="validate1()" chromeColor="#cccccc"/>
		</s:HGroup>
	</s:VGroup>
	
</s:TitleWindow>
