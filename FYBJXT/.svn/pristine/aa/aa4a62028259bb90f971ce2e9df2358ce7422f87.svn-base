<?xml version="1.0" encoding="utf-8"?>
<s:Module xmlns:fx="http://ns.adobe.com/mxml/2009"
		  xmlns:s="library://ns.adobe.com/flex/spark"
		  xmlns:mx="library://ns.adobe.com/flex/mx"
		  xmlns:component="com.xyw.sys.custom.component.*"
		  width="100%" height="100%" creationComplete="init()">
	<fx:Declarations>
		<s:RemoteObject id="f504Service" destination="f504Service"
						endpoint="{this.parentApplication.contextRoot}/messagebroker/amf"
						showBusyCursor="true">
			<s:method name="queryF504" result="queryF504Handler(event)"/>
			<s:method name="saveOrF504" result="saveOrF504Handler(event)"/>

		</s:RemoteObject>
	</fx:Declarations>
	<fx:Style>
		@namespace s "library://ns.adobe.com/flex/spark";
		s|DataGrid
		{
			borderAlpha:"0.3";
			skinClass:ClassReference("com.xyw.sys.custom.skin.CustomDataGridSkin");
			alternatingRowColors:"[#FFFFFF,#EEEEEE]"; 
		}
		
		s|DropDownList
		{
			skinClass:ClassReference("com.xyw.sys.custom.skin.CustomDropDownListSkin");
			selectionColor:#DDDDDD;
			rollOverColor:#EEEEEE;	
		}
		s|Button
		{
			skinClass:ClassReference("com.xyw.sys.custom.skin.CustomButtonSkin");
		} 
		s|Label
		{
			fontSize:13;
		}
		.myLabel
		{
			fontSize:12px;
			paddingTop:4px;
		}
		.pf10
		{
			paddingLeft:10px;
		} 
	</fx:Style>
	<fx:Script>
		<![CDATA[
			import com.xyw.module.msss.fnbj.cs.fnbjcsbgzk.zkCsTitle;
			import com.xyw.module.msss.fnbj.model.F504;
			import com.xyw.module.msss.fnbj.model.F504Request;
			import com.xyw.sys.custom.component.CompMethod;
			import com.xyw.sys.custom.component.DataGridEvent;
			import com.xyw.sys.custom.component.LoadPicWindow;
			import com.xyw.sys.custom.component.LoadPicWindow2;
			import com.xyw.sys.model.ComboBoxDataRequest;
			import com.xyw.sys.model.SystemUser;
			
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.controls.DateField;
			import mx.events.CloseEvent;
			import mx.events.FlexEvent;
			import mx.formatters.DateFormatter;
			import mx.managers.PopUpManager;
			import mx.rpc.AbstractOperation;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			import mx.rpc.remoting.Operation;
			import mx.utils.StringUtil;
			
			import spark.events.GridCaretEvent;
			import spark.events.GridSelectionEvent;
			[Bindable]
			private var systemUser:SystemUser =null;
			private var f504Request:F504Request;
			[Bindable]
			private var vf504:Object;
			private var window:zkCsTitle;
			
			
			private function init():void
			{
				this.systemUser = this.parentApplication.systemUser;
			
			}
			
			private function onSelected(event:GridSelectionEvent):void
			{
				this.vf504= DataGrid(event.target).selectedItem;
			}
			
			
			/*----------获取查询条件数据---------*/
			private function initQueryParam():void
			{
				try{
					var code:String;
					var f504:F504 = new F504();
					var fieldMap:Object=new Object();
					var f50203:String=StringUtil.trim(this.f502_03.text);
					var f50204:String=StringUtil.trim(this.f502_04.text);
					var type:String = this.f504_04.getLastSelectedInstitution();
					var f504_04:String = this.f504_04.getLastSelectedInstitutionCode();
					f504Request = new F504Request();
					if(this.systemUser.institutionType == "1")
						code = this.systemUser.institutionCode;
					else
						code = type == "8"?f504_04:f504_04.substring(0,Number(type));
					fieldMap.f50203 = null;
					fieldMap.f50204 = null;
					fieldMap.dateField = null;
					if(f50203||f50204) {
						fieldMap.f50203 = f50203;
						fieldMap.f50204 = f50204;
					} else {
						fieldMap.dateField=CompMethod.getRadioButtonValue([date]);						
						f504Request.timeStr = DateField.stringToDate(this.timeStart.text,"YYYY-MM-DD");
						f504Request.timeEnd = DateField.stringToDate(this.timeEnd.text,"YYYY-MM-DD");
					}
					f504.f50406='0';
					f504.f50415='1';
					f504.f50416='1';
					f504Request.f504 = f504;
					fieldMap.institutionCode=code;
					fieldMap.institutionCodeField="f504_04";
					f504Request.fieldMap=fieldMap;
				}catch(e:Error)
				{
					Alert.show("查询异常","系统提示");
				}
			}
			
			private function queryF504():void
			{
				_query(1,20);
			}
			
			private function queryF504Handler(event:ResultEvent):void
			{
				var f504Response:Object = event.result;
				var rowCount:Number = f504Response.rowCount;
				if(f504Response.errorMessage == null)
				{
					var listVF504:ArrayCollection = f504Response.vf504s;
					this.pagerBar.dataGrid = this.certificateDataGrid;
					this.pagerBar.rowCount = rowCount;
					this.pagerBar.resultData = listVF504;
					this.pagerBar.dataBind();
					this.pagerBar.pagerFunction = pagerFunction;
					if(rowCount > 0) {
						this.pagerBar.enabled = true;
					}
					this.vf504 =null;
				} else {
					Alert.show(f504Response.errorMessage, "系统提示");
				}
			}
			
			
			
			
			public function pagerFunction(currentPageIndex:int, pageSize:int):void
			{
				_query(currentPageIndex,pageSize);
			}
			
			public function refresh():void
			{
				this.vf504=certificateDataGrid.selectedItem=null;
				_query(this.pagerBar.currentPageIndex,20);
			}
			
			private function _query(currentPageIndex:int,pageSize:int):void
			{
				this.initQueryParam();
				f504Request.parameterPageindex = currentPageIndex;
				f504Request.parameterPagesize = pageSize;
				this.f504Service.queryF504(f504Request);
			}
			
			
			//读卡(母亲)
			protected function readCard_mother(event:MouseEvent):void
			{
				try
				{
					var str:String = ExternalInterface.call("parent.readCard");
					if(str != null && str.length != 0){
						var array:Array = str.split(",");
						var sex:String = array[1];//性别
						if(sex=="女"){
							this.f502_03.text = array[0];//姓名
							this.f502_04.text = array[5];//身份证号
							queryF504();
						}else{
							Alert.show("请读母亲信息！","系统提示");
						}
					}else{
						Alert.show("读卡失败！");
					}
				} 
				catch(error:Error) 
				{
					Alert.show("读卡失败！");
				}
			}
			
			/**
			 *
			 */
			private function modifyZg():void
			{
				
				window= new zkCsTitle();
				window.status=1;
				window.vf504=vf504;
				window.title="整改结果保存";
				window.saveStatus=false;
				CompMethod.popUpTitleWindow(window,this,true);
			}
			
			/**
			 *
			 */
			private function delZg():void
			{
				var field:String;
				var f504:F504=new F504();
				var fieldSuffix:String;
				for(var i:int=1;i<16;i++)
				{
					fieldSuffix=i<10?'0'+i:i.toString();
					field='f504'+fieldSuffix;
					if(i<11||i>14)
						f504[field]=vf504[field];
				}
				f504.f50416='2';
				f504Request = new F504Request();
				f504Request.f504=f504;
				f504Request.flag="删除整改信息";
				f504Service.saveOrF504(f504Request);
			}
			
			/**
			 *
			 */
			private function saveOrF504Handler(event:ResultEvent):void
			{
				var f504Response:Object =event.result;
				if(!f504Response.state){
					Alert.show(f504Response.errorMessage,"系统提示");
					return;
				}
				this.refresh();
				Alert.show(f504Response.promptMessage,"系统提示");
			}
		]]>
	</fx:Script>
	
	<s:Scroller width="1200" height="100%" horizontalScrollPolicy="auto" verticalScrollPolicy="auto">
		<s:VGroup>
			<mx:TabNavigator id="tab" width="100%">
				<s:NavigatorContent width="100%" label="综合查询" buttonMode="true">
					<s:VGroup>
						<s:HGroup width="100%" paddingBottom="0" paddingLeft="10" paddingRight="10"
								  verticalAlign="middle">
							<s:Label text="整改单位"/>
							<component:InstitutionComboBox id="f504_04" width="819" buttonMode="true"/>
						</s:HGroup>
						
						<s:HGroup id="LA306_01" width="100%" gap="35" paddingBottom="5" paddingLeft="10"
								  paddingRight="10" verticalAlign="middle" enabled="false">
							<s:Label text="质控结果 "/>
							<s:RadioButton label="通过" groupName="LA306_01" value="1"/>
							<s:RadioButton label="未通过" groupName="LA306_01" value="0" selected="true"/>
							<s:RadioButton label="待审核" groupName="LA306_01" value="3"/>
						</s:HGroup>
						
						
						<s:HGroup width="100%" paddingBottom="0" paddingLeft="10" paddingRight="10"
								  verticalAlign="middle">
							<s:Label text="产妇姓名"/><s:TextInput id="f502_03"/>
							<s:Label text="证号号码"/><s:TextInput id="f502_04" width="140"/>
							<s:Button id="duka1" width="60" label="读卡" click="readCard_mother(event)"
									  enabled="{systemUser.duka== '1'}"/>
						</s:HGroup>
						
						
						<s:HGroup width="100%" paddingBottom="5" paddingLeft="10" paddingRight="10"
								  verticalAlign="middle" id="date">
							<s:RadioButton label="质控时间" groupName="date" value="f504_14" selected="true"/>
							<s:RadioButton label="整改时间" groupName="date" value="f504_10"/>
							<s:RadioButton label="报告登记时间" groupName="date" value="f504_05"/>
							
							<component:CustomRangeDateField  id="timeStart" isSelectFirst="true" />

							<s:Label text="至"/>
							
							<component:CustomRangeDateField  id="timeEnd"  isSelectNow="true"/>

							<s:Button width="60" label="查询" buttonMode="true" click="queryF504()"/>
							<s:Button label="整改修改" buttonMode="true" click="modifyZg()"
									  enabled="{this.vf504}"/>
							<s:Button  label="整改删除" buttonMode="true" click="delZg()"
									  enabled="{this.vf504}"/>
							
						</s:HGroup>
						
						
					</s:VGroup>
				</s:NavigatorContent>
			</mx:TabNavigator>
			<s:DataGrid id="certificateDataGrid" width="100%" height="330"
						alternatingRowColors="[#FFFFFF,#EEEEEE]" editable="true" rowHeight="22"
						skinClass="com.xyw.sys.custom.skin.CustomDataGridSkin" selectionChange="onSelected(event)">
				<s:columns>
					<s:ArrayList>
						<s:GridColumn width="40" editable="false" headerText="序号"
									  itemRenderer="com.xyw.sys.custom.itemrenderer.CustomGridColumnItemRenderer"/>
						<s:GridColumn width="90" dataField="f50406zh" headerText="质控结果"/>
						<s:GridColumn width="80" dataField="f50416" headerText="是否整改" labelFunction="CompMethod.setStrSF"/>
						<s:GridColumn width="90" dataField="f50203" headerText="产妇姓名"/>
						<s:GridColumn width="140" dataField="f50204" headerText="产妇身份证号"/>
						<s:GridColumn width="90" dataField="f50207" headerText="联系方式"/>
						<s:GridColumn width="120" dataField="f50403" headerText="当前胎次"/>
						<s:GridColumn width="90" dataField="f50414" headerText="整改时间" labelFunction="CompMethod.setStrDate"/>
						<s:GridColumn width="150" dataField="f50404zh" headerText="报告登记单位"/>
						<s:GridColumn width="90" dataField="f50410" headerText="质控时间" labelFunction="CompMethod.setStrDate"/>
						<s:GridColumn width="90" dataField="f50408" headerText="质控人"/>
						<s:GridColumn  dataField="f50409zh" headerText="质控单位"/>
						
					</s:ArrayList>
				</s:columns>
			</s:DataGrid>
			
			<component:PagerBar id="pagerBar" enabled="false" isExcel="false" isExcel2="false"
								isPrinter="false"/>
		</s:VGroup>
	</s:Scroller>
</s:Module>
