<?xml version="1.0" encoding="utf-8"?>
<s:TitleWindow xmlns:fx="http://ns.adobe.com/mxml/2009" 
			   xmlns:s="library://ns.adobe.com/flex/spark" 
			   xmlns:mx="library://ns.adobe.com/flex/mx" 
			   xmlns:component = "com.xyw.sys.custom.component.*"
			   skinClass="com.xyw.sys.custom.skin.CustomTitleWindow"
			   title="信息修改" horizontalCenter="0" verticalCenter="0" backgroundColor="white"
			   chromeColor="#5CACEE" close = "removeWindow()" cornerRadius="5" width="1200" 
			   rollOut="overAndUp(event)"
			   rollOver="overAndUp(event)"
			 >
	<fx:Declarations>
			
			<s:RemoteObject id="f308Service" destination="f308Service" endpoint="{this.parentApplication.contextRoot}/messagebroker/amf" showBusyCursor="true">
				<s:method name="renewF308"  result="renewF308Handler(event)"/>
			</s:RemoteObject>
			
			<s:RemoteObject id="systemService" destination="systemService" endpoint="{this.parentApplication.contextRoot}/messagebroker/amf" showBusyCursor="true">
				<s:method name="getComboBoxData" result="getComboBoxDataHandler(event)"/>
			</s:RemoteObject>
			
			<mx:DateValidator id="dateValidator"  property="text"
							  inputFormat="yyyy-mm-dd" 
							  wrongLengthError="格式错误  正确格式例：2008-01-01"
							  wrongDayError="天数错误"
							  wrongMonthError="月份错误"
							  wrongYearError="年份错误"
							  invalidCharError="内容无效"
							  requiredFieldError="内容不能为空"/>
		
	</fx:Declarations>
	<fx:Style>
		@namespace s "library://ns.adobe.com/flex/spark";
		@namespace mx "library://ns.adobe.com/flex/mx";
		@namespace component "com.xyw.sys.custom.component.*";
		@namespace skin "com.xyw.sys.custom.skin.*";
		.myLabel {
			fontSize:12px;
			paddingTop:4px;
		}
		.myGrid {
			verticalAlign:middle;
		}
		.myTextInput
		{
			fontFamily:微软雅黑;
		}
		.must {
			color:red;
			fontSize:20px;
			fontWeight:bold;
			paddingTop:5px;
		}
		.errorTip
		{
			font-size: 15;
			border-color: red;/* //控制背景色 */
			color: #fff;
			font-weight: bold;
			paddingBottom:1; 
			cornerRadius:5;
		}
	</fx:Style>
		
		<fx:Script>
			<![CDATA[
				import com.xyw.module.fnbj.fnjcdj.gwfxpg;
				import com.xyw.module.fnbj.model.F301Request;
				import com.xyw.module.fnbj.model.F308;
				import com.xyw.module.fnbj.model.VF308;
				import com.xyw.sys.custom.component.CompMethod;
				import com.xyw.sys.model.ComboBoxDataRequest;
				import com.xyw.sys.model.SystemUser;
				
				import mx.collections.ArrayCollection;
				import mx.controls.Alert;
				import mx.events.CloseEvent;
				import mx.events.FlexEvent;
				import mx.managers.PopUpManager;
				import mx.rpc.events.ResultEvent;
				import mx.utils.StringUtil;
				private var comboBoxDataRequest:ComboBoxDataRequest;
				[Bindable]
				private var systemUser:SystemUser =null;
				private var num:int=5;
				private var f308:F308;
				public var vf308:Object;
				[Bindable]
				private var f30814:String;
				public var arrayTip:Array=[null,null,null,null];//保存提示信息  objId:Object,objType:String,errorString:String,tip:ToolTip
				
				private function removeWindow():void
				{
					PopUpManager.removePopUp(this);
				}
				protected function creationCompleteHandler(event:FlexEvent):void
				{
					this.systemUser =this.parentApplication.systemUser;
					initializeComboBox();
				}
				
				private function initializeComboBox():void
				{
					comboBoxDataRequest =new ComboBoxDataRequest();
					comboBoxDataRequest.showPrompt =true;
					comboBoxDataRequest.flag ="D101";
					comboBoxDataRequest.sql ="select t.d101_01, t.d101_02 from D101 t where t.d101_01 = '" + this.systemUser.institutionCode + "' or t.d101_11 ='" + this.systemUser.institutionCode +"'";
					this.systemService.getComboBoxData(this.comboBoxDataRequest);
					
					comboBoxDataRequest = new ComboBoxDataRequest();
					comboBoxDataRequest.showPrompt = true;
					comboBoxDataRequest.sql = "select * from S301_06 t";
					comboBoxDataRequest.flag = "S301_06";
					this.systemService.getComboBoxData(this.comboBoxDataRequest);
					
					comboBoxDataRequest = new ComboBoxDataRequest();
					comboBoxDataRequest.showPrompt = true;
					comboBoxDataRequest.sql = "select * from S402_04 t";
					comboBoxDataRequest.flag = "S402_04";
					this.systemService.getComboBoxData(this.comboBoxDataRequest);
					
					comboBoxDataRequest = new ComboBoxDataRequest();
					comboBoxDataRequest.showPrompt = true;
					comboBoxDataRequest.sql = "select * from S402_05 t";
					comboBoxDataRequest.flag = "S402_05";
					this.systemService.getComboBoxData(this.comboBoxDataRequest);
					
					comboBoxDataRequest = new ComboBoxDataRequest();
					comboBoxDataRequest.showPrompt = true;
					comboBoxDataRequest.sql = "select * from S601_04 t";
					comboBoxDataRequest.flag = "S601_04";
					this.systemService.getComboBoxData(this.comboBoxDataRequest);
				}
				/*-----------------返回数据放到赋值到下拉菜单-----------------*/
				private function getComboBoxDataHandler(event:ResultEvent):void
				{
					num--;
					var index:int=0;
					var comboBoxDataResponse:Object =event.result;
					var flag:String =comboBoxDataResponse.flag;
					var comboBoxDataList:ArrayCollection =comboBoxDataResponse.comboBoxDataList;
					
					if(flag =="D101"){
						index=CompMethod.getDropDownListSelectedIndex(comboBoxDataList,this.systemUser.institutionCode);
						this.F308_16.dataProvider =comboBoxDataList;
						this.F308_16.selectedIndex =index;
					}else if(flag == "S301_06"){
						index =CompMethod.getDropDownListSelectedIndex(comboBoxDataList,"1");
						this.F308_04.dataProvider = comboBoxDataList;
						this.F308_04.selectedIndex = index;
					}else if(flag == "S402_04"){
						this.F308_13.dataProvider = comboBoxDataList;
						this.F308_13.selectedIndex = index;
					}else if(flag == "S402_05"){
						this.F308_11.dataProvider = comboBoxDataList;
						this.F308_11.selectedIndex = index;
					}else if(flag == "S601_04"){
						this.F308_12.dataProvider = comboBoxDataList;
						this.F308_12.selectedIndex = index;
					}
					if(!num)
						putVF308();
					
				}
				//读卡(母亲)
				protected function readCard_mother(event:MouseEvent):void
				{
					try
					{
						//readCard是调用index.js下的函数，读卡涉及index.jsp和index.js两个文件
						var str:String = ExternalInterface.call("parent.readCard");
						if(str != null && str.length != 0){
							
							var array:Array = str.split(",");
							var sex:String = array[1];//性别
							if(sex=="女"){
								this.F308_03.text = array[0];//姓名
								this.F308_05.text = array[5];//身份证号
								this.F308_07.text = array[3];//出生日期
								//	setF303_08(null);
								var nation:String = array[2] + "族";//民族
							}else{
								Alert.show("请读母亲信息！","系统提示");
							}
						}else{
							Alert.show("读卡失败！");
						}
					} 
					catch(error:Error) 
					{
						Alert.show("读卡失败！");
					}
				}
				
				protected function button1_clickHandler(event:MouseEvent):void
				{
					var vbox:Object=this.parent;
					var superTabNavigator1:Object=this.parent.parent; 
					this.parentApplication.contentLabel=vbox.label;
					superTabNavigator1.removeElement(vbox);
					this.parentApplication.loadModule("com/xyw/module/fnbj/fnjcdj2/index.swf");
				}
				protected function overAndUp(event:MouseEvent):void
				{
					if(event.type==MouseEvent.ROLL_OVER)
					{ 
						if(!arrayTip[3])
							arrayTip=CompMethod.showTip(arrayTip[0],arrayTip[1],arrayTip[2],arrayTip[3]);
						if(!this.hasEventListener(Event.ENTER_FRAME))
							this.addEventListener(Event.ENTER_FRAME,enterFrameHandler); 
					}else
					{
						this.removeEventListener(Event.ENTER_FRAME,enterFrameHandler);			
						arrayTip[3]=CompMethod.destoryTip(arrayTip[3]);		
					}
					
				}
				
				/***************显示删除提示信息*********************/
				private function enterFrameHandler(event:Event):void
				{
					if(arrayTip[3])	
						arrayTip=CompMethod.showTip(arrayTip[0],arrayTip[1],arrayTip[2],arrayTip[3]);		 
				}
				
				private function gaowei_clickHandler(event:MouseEvent):void
				{
					var gw:gwfxpg = new gwfxpg();
					CompMethod.popUpTitleWindow(gw,this,true);
					
				}
				/**
				 *时间输入验证
				 */
				private function focusOut(id:Object):Boolean
				{
					var textDate:Date=DateField.stringToDate(id.text,"YYYY-MM-DD");
					if(id.errorString&&!textDate)
					{
						var str:String=id.errorString;
						id.errorString='';
						dateValidator.source=null;
						if((str.lastIndexOf("yyyy-mm-dd"))!=-1)
							str=str.substring(0,str.lastIndexOf("yyyy-mm-dd"));
						//保存提示信息  objId:Object,objType:String,errorString:String,tip:ToolTip
						arrayTip=CompMethod.showTip(id,"3",str,arrayTip[3]);
						return true;
					}else
						return dateValidatorHandler(id,textDate);
				}
				
				/**
				 *清空提示 格式化日期
				 */
				private function dateValidatorHandler(id:Object,textDate:Date):Boolean
				{
					dateValidator.source=null;
					id.errorString='';
					if(arrayTip[3])
					{
						CompMethod.destoryTip(arrayTip[3]);	
						arrayTip=[null,null,null,null]
					}					
					if(textDate)
						id.text=DateField.dateToString(textDate,"YYYY-MM-DD");
					return false;
				}
				
				/**
				 *得到所选择的信息 
				 */
				public function getColor(allColor:Array):void
				{
					for(var i:int=allColor.length-1;i>-1;i--)
					{
						if(allColor[i].length)
						{
							if(i>1)
								getGWMessage(allColor[i]);
							else
								setGW();
							F308_13.selectedIndex=++i;
							F308_14.toolTip=F308_14.text;
							break;
						}else
							setGW(true);
					}
				}
				/**
				 *恢复初始化
				 */
				private function setGW(flag:Boolean=false):void
				{
					
					if(flag)
						F308_13.selectedIndex=0;
					F308_14.text="无"
					F308_14.toolTip=F308_14.text;
					
				}
				/**
				 *得到选择的名称
				 */
				private function getGWMessage(arrMessage:Array):void
				{
					F308_14.text=f30814="";
					for(var i:String in arrMessage)
					{
						f30814+=arrMessage[i][0]+"!";
						F308_14.text+=arrMessage[i][0]+"\n";
					}
					
				}
				
				private function validatePerinata():void
				{
					if(arrayTip[3])
						return;
					if(StringUtil.trim(F308_10.text)=="")
					{
						Alert.show("请输入电话号码","系统提示");
						return;
					}
					if(StringUtil.trim(F308_08.text)=="")
					{
						Alert.show("请输入孕周","系统提示");
						return;
					}
					if(StringUtil.trim(F308_09.text)=="")
					{
						Alert.show("请输入天数","系统提示");
						return;
					}
					if(!F308_11.selectedIndex)
					{
						Alert.show("请选择产前产后","系统提示");
						return;
					}
					
					if(!F308_13.selectedIndex)
					{
						Alert.show("请点击高危评估按钮","系统提示");
						return;
					}
					
					if(F308_13.selectedIndex>2)
					{
						if(!F308_12.selectedIndex)
						{
							Alert.show("请选择是否转诊","系统提示");
							return;
						}
					}
					
					if(StringUtil.trim(F308_15.text)=="")
					{
						Alert.show("请输入建档人","系统提示");
						return;
					}
					if(StringUtil.trim(F308_17.text)=="")
					{
						Alert.show("请输入建档日期","系统提示");
						return;
					}
					saveF308();
				}
				
				private function saveF308():void
				{
					f308.f30803=StringUtil.trim(F308_03.text);
					f308.f30804=F308_04.selectedItem.data;
					f308.f30805=StringUtil.trim(F308_05.text);
					f308.f30806=StringUtil.trim(F308_06.text);
					f308.f30807=F308_07.selectedDate;
					f308.f30808=StringUtil.trim(F308_08.text);
					f308.f30809=StringUtil.trim(F308_09.text);
					f308.f30810=StringUtil.trim(F308_10.text);
					f308.f30811=F308_11.selectedItem.data;
					f308.f30812=F308_12.selectedItem.data;
					f308.f30813=F308_13.selectedItem.data;
					f308.f30814=f30814;
					f308.f30815=StringUtil.trim(F308_15.text);
					f308.f30816=F308_16.selectedItem.data;
					f308.f30817=F308_17.selectedDate;
					f308Service.renewF308(f308);
				}
				
				private function renewF308Handler(event:ResultEvent):void
				{
					var f308Response:Object=event.result;
					if(f308Response.state)
					{
						Alert.show(f308Response.promptMessage,"系统提示",1,this,closeHandler);
					}else
						Alert.show(f308Response.errorMessage,"系统提示");
				}
				
				private function closeHandler(event:CloseEvent):void
				{
					if(event.detail==1)
					{
						var index:Object=this.owner;
						index.refresh();
					}
				}
				
				private function putVF308():void
				{
					f308=new F308();
					f308.f30801=vf308.f30801;
					f308.f30802=vf308.f30802;
					F308_03.text=vf308.f30803;
					F308_05.text=vf308.f30805;
					F308_06.text=vf308.f30806;
					F308_08.text=vf308.f30808;
					F308_09.text=vf308.f30809;
					F308_10.text=vf308.f30810;
					F308_15.text=vf308.f30815;
					F308_07.selectedDate=vf308.f30807;
					F308_17.selectedDate=vf308.f30817;
					F308_04.selectedIndex=CompMethod.getDropDownListSelectedIndex(ArrayCollection(F308_04.dataProvider),vf308.f30804);
					F308_11.selectedIndex=CompMethod.getDropDownListSelectedIndex(ArrayCollection(F308_11.dataProvider),vf308.f30811);
					F308_12.selectedIndex=CompMethod.getDropDownListSelectedIndex(ArrayCollection(F308_12.dataProvider),vf308.f30812);
					F308_13.selectedIndex=CompMethod.getDropDownListSelectedIndex(ArrayCollection(F308_13.dataProvider),vf308.f30813);
					F308_16.selectedIndex=CompMethod.getDropDownListSelectedIndex(ArrayCollection(F308_16.dataProvider),vf308.f30816);
					setF308_14(vf308.f30814);
				}
				private function setF308_14(str:String):void
				{
					if(str&&str!='无')
					{
						f30814=str;
						var arr:Array=str.split('!') ;
						for(var i:int=0; i<arr.length;i++)
						{
							if(!arr[i])
								continue;
							F308_14.text+=arr[i]+'\n';
						}
						if(F308_14.text!="无")
							F308_14.toolTip=F308_14.text;	
					}else
						F308_14.text="无";
				}
			]]>
		</fx:Script>
		<s:Scroller x="-6" y="1" width="100%" height="100%" horizontalScrollPolicy="auto" verticalScrollPolicy="auto">
			<s:VGroup paddingBottom="20" paddingLeft="10" paddingRight="10" paddingTop="10" creationComplete="creationCompleteHandler(event)">
				<mx:TabNavigator id="content" width="1155" chromeColor="#ffffff" creationPolicy="all">
					<s:NavigatorContent width="100%" label="基本信息">
						<mx:Grid paddingLeft="8" paddingBottom="10">
							<mx:GridRow>
								<mx:GridItem>
									<s:Label styleName="myLabel" text="孕 妇  姓 名"/>	
									<s:TextInput id="F308_03" width="130" editable="false"/>	
								</mx:GridItem>
								<mx:GridItem>
									<s:Label styleName="myLabel" text="证件类型" paddingLeft="15"/>
									<component:CustomDropDownList id="F308_04" width="130" enabled="false"/>
									
								</mx:GridItem>
								<mx:GridItem>
									<s:Label styleName="myLabel" text="证件号码" paddingLeft="15"/>
									<s:TextInput id="F308_05" width="140" editable="false"/>
									
								</mx:GridItem>
								<mx:GridItem>
									<s:Label styleName="myLabel" text="出生日期" paddingLeft="15"/>
									<mx:DateField id="F308_07" width="130" 
												  dayNames="[&quot;周日&quot;,&quot;周一&quot;,&quot;周二&quot;,&quot;周三&quot;,&quot;周四&quot;,&quot;周五&quot;,&quot;周六&quot;]"
												  formatString="YYYY-MM-DD"
												  monthNames="[&quot;一月&quot;,&quot;二月&quot;,&quot;三月&quot;,&quot;四月&quot;,&quot;五月&quot;,&quot;六月&quot;,&quot;七月&quot;,&quot;八月&quot;,&quot;九月&quot;,&quot;十月&quot;,&quot;十一月&quot;,&quot;十二月&quot;]"
												  enabled="false" yearNavigationEnabled="true"
												  />
									
									<s:Button buttonMode="true" label="读卡" id="duka2" enabled="{systemUser.duka =='1'}"  click="readCard_mother(event)"/>
								</mx:GridItem>
							</mx:GridRow>
							<mx:GridRow>	
								<mx:GridItem>
									<s:Label styleName="myLabel" text="联 系  电 话" />
									<s:TextInput id="F308_10" restrict="0-9"/>
									
								</mx:GridItem>
								
								<mx:GridItem>
									<s:Label styleName="myLabel" text="孕  周  天" paddingLeft="15"/>
									<s:BorderContainer  height="23" width="130">
										<s:HGroup verticalAlign="middle">
											<s:TextInput id="F308_08" width="50" borderVisible="false"
														 maxChars="2" restrict="0-9" text="40"
														 textAlign="right"/>
											<s:Label styleName="myLabel" text="周    "/>
											<s:TextInput id="F308_09" width="34"
														 borderVisible="false" maxChars="1"
														 restrict="0-6" text="0" textAlign="right"/>
											<s:Label styleName="myLabel" text="天    "/>
										</s:HGroup>
									</s:BorderContainer>
									
								</mx:GridItem>
								<mx:GridItem>
									<s:Label styleName="myLabel" text="产前产后" paddingLeft="15"/>
									<s:DropDownList id="F308_11" width="140" />
								</mx:GridItem>
								<mx:GridItem>
									<s:Label styleName="myLabel" text="建册编号" paddingLeft="15"/>	
									<s:TextInput id="F308_06" width="130" editable="false"/>
									<s:Button buttonMode="true" label="高危评估" id="gaowei" click="gaowei_clickHandler(event)"/>
								</mx:GridItem>
							</mx:GridRow>
							<mx:GridRow>
								<mx:GridItem>
									<s:Label styleName="myLabel" text="高 危  级 别" />
									<s:DropDownList id="F308_13" width="130" enabled="false" color="#E61717"  
													change="if(F308_13.selectedIndex&lt;2)F308_12.selectedIndex=0"/>
								</mx:GridItem>
								<mx:GridItem  colSpan="2">
									<s:Label styleName="myLabel" text="高危原因" paddingLeft="15"/>
									<s:TextInput id="F308_14" editable="false" width="360"/>
								</mx:GridItem>
								<mx:GridItem>
									<s:Label styleName="myLabel" text="是否转诊" paddingLeft="15"/>
									<s:DropDownList id="F308_12" width="140" enabled="{F308_13.selectedIndex>2}"/>
								</mx:GridItem>
							</mx:GridRow>
						</mx:Grid>
					</s:NavigatorContent>
				</mx:TabNavigator>
				<mx:TabNavigator width="1155" chromeColor="#ffffff" creationPolicy="all">
					<s:NavigatorContent width="100%" label="登记信息">	
						<mx:Grid paddingLeft="8" paddingBottom="10">
							<mx:GridRow>
								<mx:GridItem>
									<s:Label styleName="myLabel" text="建档人员"/>
									<s:TextInput id="F308_15" width="130" focusIn="if(F308_13.selectedIndex==0)arrayTip=CompMethod.showTip(gaowei,'3','请点击高危评估按钮',arrayTip[3])"/>
									
								</mx:GridItem>
								<mx:GridItem>
									<s:Label styleName="myLabel" text="建档医院" paddingLeft="20"/>
									<component:CustomDropDownList id="F308_16" width="130" enabled="false"/>
									
								</mx:GridItem>
								<mx:GridItem>
									<s:Label styleName="myLabel" text="建档时间" paddingLeft="10"/>
									<mx:DateField yearNavigationEnabled="true" id="F308_17" width="140" dayNames='["周日","周一","周二","周三","周四","周五","周六"]'
												  monthNames='["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"]'
												  formatString="YYYY-MM-DD" editable="true"    restrict="0-9\-"
												  focusIn="dateValidator.source=F308_17;arrayTip=CompMethod.showTip(F308_15,'1','请填写建档人员',arrayTip[3])"
												  focusOut="focusOut(F308_17)" />
									
								</mx:GridItem>
							</mx:GridRow>
						</mx:Grid>
					</s:NavigatorContent>
				</mx:TabNavigator>
				<s:HGroup verticalAlign="middle" horizontalAlign="center" paddingBottom="5" paddingTop="5" width="1155">
					<s:Button label="保存" buttonMode="true" chromeColor="#CCCCCC"
							  click="validatePerinata()" enabled="{F308_03.text}"/>
				</s:HGroup>
			</s:VGroup>
		</s:Scroller>

</s:TitleWindow>


