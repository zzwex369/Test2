<?xml version="1.0" encoding="utf-8"?>
<s:TitleWindow xmlns:fx="http://ns.adobe.com/mxml/2009" 
		  xmlns:s="library://ns.adobe.com/flex/spark" 
		  xmlns:mx="library://ns.adobe.com/flex/mx" width="924" height="354" xmlns:component="com.xyw.sys.custom.component.*" creationComplete="moduleComplete()" close="removeWindow()" backgroundColor="white" chromeColor="#5CACEE" title="信息修改" cornerRadius="5">
	<fx:Declarations>
		<s:RemoteObject id="systemService" destination="systemService" endpoint="{this.parentApplication.contextRoot}/messagebroker/amf" showBusyCursor="true">
			<s:method name="getComboBoxData" result="getComboBoxDataHandler(event)"/>
		</s:RemoteObject>
		<s:RemoteObject id="e704Service" destination="e704Service" endpoint="{this.parentApplication.contextRoot}/messagebroker/amf" showBusyCursor="true">
			<s:method name="updateE704" result="updateE704Handler(event)"/>
		</s:RemoteObject>
	</fx:Declarations>
	<fx:Style>
		@namespace s "library://ns.adobe.com/flex/spark";
		@namespace mx "library://ns.adobe.com/flex/mx";
		
		s|SkinnableTextBase:disabledWithPrompt {
			color: #000000;
			fontStyle:normal;
			
		}
		s|SkinnableTextBase:normalWithPrompt {
			color: #000000;
			fontStyle:normal;
			
		}
		.myLabel
		{
			fontSize:12;
		}
		.must {
			color:red;
			fontSize:20px;
			fontWeight:bold;
			paddingTop:5px;
		}
		
	</fx:Style>
	<fx:Script>
		<![CDATA[
			import com.xyw.module.etbj.etsl.model.E704;
			import com.xyw.sys.custom.component.CompMethod;
			import com.xyw.sys.model.ComboBoxDataRequest;
			import com.xyw.sys.model.SystemUser;
			
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.controls.DateField;
			import mx.events.CloseEvent;
			import mx.managers.PopUpManager;
			import mx.rpc.events.ResultEvent;
			import mx.utils.StringUtil;
			
			
			[Bindable]
			public var systemUser:SystemUser = null;
			private var comboBoxDataRequest:ComboBoxDataRequest;
			private var jigouindex:int;
			public var ve704:Object;
			public var e704:E704;
			
			private function moduleComplete():void
			{
				this.systemUser = this.parentApplication.systemUser;
				var now:Date =new Date();
				this.e704_16.selectedDate =now;
				this.initializeComboBox();
				this.e704_12.addEventListener(Event.CHANGE,redioh);
				this.e704_12_.addEventListener(Event.CHANGE,redioh_);
				putVaule();
			}
			public function redioh(event:Event):void{
				e704_14.enabled = true;
			}
			public function redioh_(event:Event):void{
				e704_14.enabled = false;
			}
			public function putVaule():void{
				e704_03.text = ve704.e70403;
				e704_04.text = ve704.e70404;
				e704_05.text = ve704.e70405;
				e704_06.selectedDate = ve704.e70406;
				if("2"==ve704.e70410){
					e704_10_.selected=true;
				}
				if("2"==ve704.e70412){
					e704_12_.selected=true;
					e704_14.enabled = false;
				}
				e704_11.text = ve704.e70411;
				e704_13.text = ve704.e70413;
				e704_14.text = ve704.e70414;
				e704_17.text = ve704.e70417;
				e704_09.selectedIndex=CompMethod.getDropDownListSelectedIndex(e704_09.dataProvider,ve704.e70409);
			}
			private function initializeComboBox():void
			{
				comboBoxDataRequest = new ComboBoxDataRequest();
				comboBoxDataRequest.showPrompt = true;
				comboBoxDataRequest.sql = "select t.d101_01, t.d101_02 from D101 t "; //where t.d101_01 ="+this.systemUser.institutionCode+"or t.d101_11 ="+this.systemUser.institutionCode;
				comboBoxDataRequest.flag = "D101";//单位
				this.systemService.getComboBoxData(this.comboBoxDataRequest);
				
				
				
				comboBoxDataRequest = new ComboBoxDataRequest();
				comboBoxDataRequest.showPrompt = true;
				comboBoxDataRequest.sql = "select * from Z503_16";
				comboBoxDataRequest.flag = "Z503_16";
				this.systemService.getComboBoxData(this.comboBoxDataRequest);
				
				comboBoxDataRequest = new ComboBoxDataRequest();
				comboBoxDataRequest.showPrompt = true;
				comboBoxDataRequest.sql = "select * from Z503_17";
				comboBoxDataRequest.flag = "Z503_17";
				this.systemService.getComboBoxData(this.comboBoxDataRequest);
			}
			private function getComboBoxDataHandler(event:ResultEvent):void
			{
				var comboBoxDataResponse:Object =  event.result;
				var flag:String = comboBoxDataResponse.flag;
				var comboBoxDataList:ArrayCollection = comboBoxDataResponse.comboBoxDataList;
				if(flag == "D101")//单位
				{
					jigouindex = this.getDropDownListSelectedIndex(comboBoxDataList, this.systemUser.institutionCode);
					this.e704_15.dataProvider = comboBoxDataList;
					this.e704_15.selectedIndex = jigouindex;
				}else if(flag == "Z503_16")
				{
					this.e704_07.dataProvider = comboBoxDataList;
					this.e704_07.selectedIndex = getDropDownListSelectedIndex(comboBoxDataList, ve704.e70407);
				}else if(flag == "Z503_17")
				{
					this.e704_08.dataProvider = comboBoxDataList;
					this.e704_08.selectedIndex = getDropDownListSelectedIndex(comboBoxDataList, ve704.e70408);
				}
			}
			private function savee704(event:MouseEvent):void
			{
				
				var bool:Boolean = validate1();
				if(!bool){
					return;
				}
				Alert.yesLabel = "确定";
				Alert.noLabel = "取消";
				Alert.show('确认保存？','保存信息',1|2,this,savee704_hanlder);
			}
			private function savee704_hanlder(event:CloseEvent):void{
				if(event.detail == Alert.YES){
					quzhi();
					e704Service.updateE704(e704);
					//clear();
				}
			}
			public function updateE704Handler(event:ResultEvent):void{
				var e704Response:Object =event.result;
				if(!e704Response.falg){
					
					Alert.show("请稍后重试","系统提示");
					return;
				}
				Alert.show("修改成功！ ","系统提示");
				dispatchEvent(new Event("ok_click"));
				this.removeWindow();
			}
			private function clear():void{
				this.e704_03.text="";
				this.e704_04.text="";
				this.e704_05.text="";
				this.e704_06.text="";
				this.e704_11.text="";
				this.e704_13.text="";
				this.e704_14.text="";
				this.e704_17.text="";
				
				this.e704_10.selected=true;
				this.e704_12.selected=true;
				this.e704_07.selectedIndex=0;
				this.e704_08.selectedIndex=0;
				this.e704_08.selectedIndex=jigouindex;
			}
			private function quzhi():void{
				e704 = new E704();
				e704.e70401=ve704.e70401;
				e704.e70402=ve704.e70402;
				e704.e70403=StringUtil.trim(e704_03.text);
				e704.e70404=StringUtil.trim(e704_04.text);
				e704.e70405=StringUtil.trim(e704_05.text);
				e704.e70406=DateField.stringToDate(e704_06.text,'YYYY-MM-DD');
				e704.e70407=e704_07.selectedItem.data;
				e704.e70408=e704_08.selectedItem.data;
				e704.e70409=e704_09.selectedItem.data;
				e704.e70416=DateField.stringToDate(e704_16.text,'YYYY-MM-DD');
				if(e704_08.selectedItem.data==1||e704_08.selectedItem.data==2){
					e704.e70415=e704_15.selectedItem.data;
					e704.e70417=StringUtil.trim(e704_17.text);
					return;
				}
				if(!e704_10.selected){
					e704.e70410="2";
					e704.e70411=StringUtil.trim(e704_11.text);
				}else{
					e704.e70410="1";
				}
				if(!e704_12.selected){
					e704.e70412="2";
					e704.e70413=StringUtil.trim(e704_13.text);
				}else{
					e704.e70412="1";
					e704.e70414=StringUtil.trim(e704_14.text);
				}
				e704.e70415=e704_15.selectedItem.data;
				e704.e70417=StringUtil.trim(e704_17.text);
			}
			private function validate1():Boolean
			{
				if(StringUtil.trim(e704_03.text)==""){
					Alert.show("请输入儿童的姓名","系统提示");
					return false;
				}
				var patternMonther:RegExp = /^(\d{18,18}|\d{15,15}|\d{17,17}X|\d{17,17}x)$/g;
				if(StringUtil.trim(this.e704_04.text)!=""&&!patternMonther.test(this.e704_04.text)){
					Alert.show("身份证号码有误!","系统提示");
					return false;
				}
				if(StringUtil.trim(e704_05.text)==""){
					Alert.show("请输入随访人姓名","系统提示");
					return false;
				}
				if(!StringUtil.trim(e704_06.text)){
					Alert.show("请输入随访日期","系统提示");
					return false;
				}
				if(e704_07.selectedItem.data==0){
					Alert.show("请输入随访方式","系统提示");
					return false;
				}
				if(e704_08.selectedItem.data==0){
					Alert.show("请输入随访结果","系统提示");
					return false;
				}
				if(e704_09.selectedItem==null){
					Alert.show("请输入随访单位","系统提示");
					return false;
				}
				if(e704_09.selectedItem.data==0){
					Alert.show("请输入随访单位","系统提示");
					return false;
				}
				if(e704_08.selectedItem.data==1||e704_08.selectedItem.data==2){
					if(StringUtil.trim(e704_17.text)==""||StringUtil.trim(e704_17.text)=="选择")
					{
						Alert.show("请输入录入人员信息","系统提示");
						return false;
					}
					return true;
				}
				if(!e704_10.selected&&StringUtil.trim(e704_11.text)==""){
					Alert.show("请输入未筛查原因","系统提示");
					return false;
				}
				if(!e704_12.selected&&StringUtil.trim(e704_13.text)==""){
					Alert.show("请输入未转诊原因","系统提示");
					return false;
				}
				if(e704_12.selected&&StringUtil.trim(e704_14.text)==""){
					Alert.show("请输入转诊情况","系统提示");
					return false;
				}
				if(StringUtil.trim(e704_17.text)==""){
					Alert.show("请输入录入人","系统提示");
					return false;
				}
				return true;
			}
			private function getDropDownListSelectedIndex(arrayCollection:ArrayCollection, defaultValue:String):int
			{
				var len:uint = arrayCollection.length;
				var i:uint = 0;
				var index:int = 0;
				while(i < len) {
					var comboBoxDataP:Object = arrayCollection.getItemAt(i);
					if(comboBoxDataP.data == defaultValue) {
						index = arrayCollection.getItemIndex(comboBoxDataP);
						break;
					}
					i++;
				}	
				return index;
			}
			private function removeWindow():void
			{ 
				PopUpManager.removePopUp(this);
			}
		]]>
	</fx:Script>
	<s:Scroller x="1" y="1" width="921" height="100%" horizontalScrollPolicy="auto"
				verticalScrollPolicy="auto">
		<s:VGroup width="100%">
			<mx:TabNavigator width="920" chromeColor="#ffffff" creationPolicy="all">
				<s:NavigatorContent width="100%" label="基本信息">
					<s:VGroup width="918" paddingBottom="2" paddingLeft="3" paddingRight="10">	
						<mx:Grid paddingLeft="1" paddingBottom="1">
							<mx:GridRow>
								<mx:GridItem>
									<s:Label paddingLeft="2" paddingTop="0" text="儿童姓名" styleName="myLabel"/>
									<s:TextInput id="e704_03" width="130" editable="false"/>
									<s:Label text="*" styleName="must"/>
								</mx:GridItem>
								<mx:GridItem>
									<s:Label paddingLeft="2" paddingTop="0" text="身份证号" styleName="myLabel"/>
									<s:TextInput id="e704_04" width="149"/>
								</mx:GridItem>
								<mx:GridItem width="224">
									<s:Label paddingLeft="2" paddingTop="0" text="随  访  人" styleName="myLabel"/>
									<s:TextInput id="e704_05" width="183"/>
									<s:Label text="*" styleName="must"/>
								</mx:GridItem>
								<mx:GridItem>
									<s:Label paddingLeft="2" paddingTop="0" text="随访日期" styleName="myLabel"/>
									<component:CustomRangeDateField  id="e704_06" isSelectNow="true"/>
									<s:Label text="*" styleName="must"/>
								</mx:GridItem>
							</mx:GridRow>
							<mx:GridRow>
								<mx:GridItem>
									<s:Label paddingLeft="2" paddingTop="0" text="随访方式" styleName="myLabel"/>
									<s:DropDownList id="e704_07" width="130"/>
									<s:Label text="*" styleName="must"/>
								</mx:GridItem>
								<mx:GridItem>
									<s:Label paddingLeft="2" paddingTop="0" text="随访结果" styleName="myLabel"/>
									<s:DropDownList id="e704_08" width="150"/>
									<s:Label text="*" styleName="must"/>
								</mx:GridItem>
								<mx:GridItem>
									<s:Label paddingLeft="2" paddingTop="0" text="随访单位" styleName="myLabel"/>
									<component:institutionCodeComboBox id="e704_09" width="184"/>
									<s:Label text="*" styleName="must"/>
								</mx:GridItem>
							</mx:GridRow>
						</mx:Grid>
					</s:VGroup>
				</s:NavigatorContent>
			</mx:TabNavigator>
			<mx:TabNavigator width="919" height="116" chromeColor="#ffffff" creationPolicy="all">
				<s:NavigatorContent width="100%" label="随访信息">
					<s:VGroup width="917" paddingLeft="3">
						
						<s:HGroup width="916">
							<s:Label paddingLeft="2" paddingTop="4" text="是否筛查" styleName="myLabel"/>
							<s:RadioButton id="e704_10" label="已筛查" buttonMode="true" selected="true" groupName="e_10" value="1"/>
							
							
							<s:RadioButton id="e704_10_" label="未筛查" buttonMode="true" groupName="e_10" value="2"/>
							<s:TextInput id="e704_11" width="732" prompt="未筛查原因" enabled="{e704_10.selected==false}"/>
						</s:HGroup>
						<s:HGroup width="917">
							<s:Label paddingLeft="2" paddingTop="4" text="是否转诊" styleName="myLabel"/>
							<s:RadioButton  id="e704_12" label="已转诊" buttonMode="true" selected="true" groupName="e_12" value="1"/>
							
							
							<s:RadioButton id="e704_12_" label="未转诊" buttonMode="true" groupName="e_12" value="2"/>
							<s:TextInput id="e704_13" width="732" prompt="未转诊原因" enabled="{e704_12.selected==false}"/>
						</s:HGroup>
						
						<s:HGroup>
							<s:Label paddingLeft="2" paddingTop="4" text="诊治情况" enabled="{e704_12_.selected==false}" styleName="myLabel"/>
							<s:TextInput id="e704_14" width="859"/>
						</s:HGroup>
					</s:VGroup>
				</s:NavigatorContent>
			</mx:TabNavigator>
			<mx:TabNavigator width="919" chromeColor="#ffffff" creationPolicy="all">
				<s:NavigatorContent width="100%" label="录入信息">			
					<s:VGroup paddingBottom="2" paddingLeft="3" paddingRight="10">	
						<s:HGroup width="100%" height="100%" paddingBottom="5" verticalAlign="middle" paddingLeft="3">
							<s:Label text="录入单位" styleName="myLabel"/><s:DropDownList width="166" id="e704_15" enabled="false"/>
							
							<s:Label text="录入人" styleName="myLabel"/><s:TextInput width="130" id="e704_17"/>
							<s:Label text="录入时间" styleName="myLabel"/>
							<component:CustomRangeDateField  id="e704_16" enabled="false" isSelectNow="true"/>
							
						</s:HGroup>
					</s:VGroup>
				</s:NavigatorContent>
			</mx:TabNavigator>
			<s:HGroup width="865" height="30" contentBackgroundColor="#FF0000"
					  horizontalAlign="center" paddingBottom="20" paddingLeft="10" paddingTop="10"
					  verticalAlign="middle">
				<s:Button  width="68" label="保存" buttonMode="true" id="save"  click="savee704(event)"/>
			</s:HGroup>
		</s:VGroup>
	</s:Scroller>
</s:TitleWindow>
