<?xml version="1.0" encoding="utf-8"?>
<s:VGroup xmlns:fx="http://ns.adobe.com/mxml/2009"
		  xmlns:s="library://ns.adobe.com/flex/spark"
		  xmlns:mx="library://ns.adobe.com/flex/mx"
		  xmlns:fngjeda="com.xyw.module.msss.la.fngjadacx.*"
		  xmlns:component="com.xyw.sys.custom.component.*"
		  width="100%" maxHeight="{this.parentApplication.stage.stageHeight-50}"
		  creationComplete="init()" >
	<fx:Declarations>
		<s:RemoteObject id="systemService" destination="systemService"
						endpoint="{this.parentApplication.contextRoot}/messagebroker/amf"
						showBusyCursor="true">
			<s:method name="getComboBoxData" result="getComboBoxDataHandler(event)"/>
		</s:RemoteObject>
		<s:RemoteObject id="l302Service" destination="l302Service"
						endpoint="{this.parentApplication.contextRoot}/messagebroker/amf"
						showBusyCursor="true">
			<s:method name="saveL302" result="saveOrRenewL302Handler(event)"/>
			<s:method name="renewL302" result="saveOrRenewL302Handler(event)"/>
		</s:RemoteObject>
	</fx:Declarations>
	<fx:Metadata>
		[Event(name="saveSuccess", type="flash.events.Event")]
	</fx:Metadata>
	<fx:Style>
		@namespace s "library://ns.adobe.com/flex/spark";
		@namespace mx "library://ns.adobe.com/flex/mx";
		@namespace component "com.xyw.sys.custom.component.*";
		@namespace skin "com.xyw.sys.custom.skin.*";
		
		.myStyle {
			paddingTop:4px;
			fontSize:12;
		}
	</fx:Style>
	<fx:Script>
		<![CDATA[
			import com.xyw.module.msss.la.model.L302;
			import com.xyw.module.msss.la.model.L302Request;
			import com.xyw.module.msss.la.model.VL302;
			import com.xyw.sys.custom.component.CompMethod;
			import com.xyw.sys.model.ComboBoxDataRequest;
			import com.xyw.sys.model.SystemUser;
			
			import flashx.textLayout.elements.BreakElement;
			
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.controls.DateField;
			import mx.core.Container;
			import mx.events.CloseEvent;
			import mx.events.FlexEvent;
			import mx.managers.PopUpManager;
			import mx.rpc.events.ResultEvent;
			import mx.utils.StringUtil;
			
			import spark.events.IndexChangeEvent;
			
			
			private var comboBoxDataRequest:ComboBoxDataRequest;
			private var systemUser:SystemUser;
			[Bindable]
			public var l302:L302;
			public  var l30202:String;
			[Bindable]
			public var state:String;
			[Bindable]
			public var vl302:VL302;
		
			
			private function init():void
			{
				var status:Boolean=true;
				if(l302)
				{
					if(!l302.l30259||!l302.l30276)
						status=false;
				}else
				{
					if(!vl302.l30259||!vl302.l30276)
						status=false;
				}
				if(!status)
				{
					this.enabled=status;
					return ;
				}
				systemUser=this.parentApplication.systemUser;
				initializeComboBox();
				
			}
			private function _initializeComboBox(sql:String,flag:String,showPrompt:Boolean=true):void
			{
				comboBoxDataRequest = new ComboBoxDataRequest();
				comboBoxDataRequest.sql = sql;
				comboBoxDataRequest.flag = flag;
				comboBoxDataRequest.showPrompt = showPrompt;
				this.systemService.getComboBoxData(this.comboBoxDataRequest);
			}
			
			/******************下拉框填充数据******************/
			private function initializeComboBox():void
			{
			
				_initializeComboBox("select * from d101 t where d101_01="+systemUser.institutionCode,"D101",false);
				
				
			}
			/******************得到数据******************/
			private function getComboBoxDataHandler(event:ResultEvent):void
			{
				var comboBoxDataResponse:Object =  event.result;
				var flag:String = comboBoxDataResponse.flag;
				var comboBoxDataList:ArrayCollection = comboBoxDataResponse.comboBoxDataList;
				if(flag == "D101")
				{
					L302_171.dataProvider=comboBoxDataList;
					L302_171.selectedIndex=0;
				}else if(flag == "S301_10")
				{
					L302_172.dataProvider=comboBoxDataList;
					L302_172.selectedIndex=0;
					return ;
				}
				if("0"==state)
					 callLater(updateCsjy);
				else
					_initializeComboBox("select t.s_01,t.s_02 from S301_10 t where t.S_05='9' and t.S_04 ="+this.systemUser.userCode,"S301_10",false);

			}
			
			
			private function updateCsjy():void
			{
				
				L302_170.text=vl302.l302170;
				L302_172.text=vl302.l302172;
				L302_173.text=DateField.dateToString(vl302.l302173,"YYYY-MM-DD");
				CompMethod.setRadioButtonSelect([L302_75],vl302.l30275);
				L302_171.selectedIndex=CompMethod.getDropDownListSelectedIndex(L302_171.dataProvider,vl302.l302171);

			}
			
			/**
			 *
			 */
			private function saveCsjy():void
			{
				
				if(L302_170.enabled&&!L302_170.text)
				{
					Alert.show("请输入临床建议 其他 ","系统提示");
					return;
				}
				
				if(!L302_172.text)
				{
					Alert.show("请输入评估医师","系统提示");
					return ;
				} 
				_saveCsjy();
			}
			
			
			private function _saveCsjy():void
			{
				save.enabled=false;
				l30202=l302?l302.l30202:vl302.l30202;
				l302=new L302();
				
				l302.l30275=CompMethod.getRadioButtonValue(L302_75);
				l302.l302170=StringUtil.trim(L302_170.text);
				l302.l302171=L302_171.selectedItem.data;
				l302.l302172=StringUtil.trim(L302_172.text);
				l302.l302173=DateField.stringToDate(L302_173.text,"YYYY-MM-DD");
				var l302Request:L302Request=new L302Request();
				l302Request.flag="9";
				if("0"==state)
				{
					l302.l30201=vl302.l30201;
					l302Request.l302=l302;
					l302Service.renewL302(l302Request);
				}else
				{	
					l302.l30202=l30202;
					l302Request.l302=l302;
					l302Service.saveL302(l302Request);
				}
			}
			private function saveOrRenewL302Handler(event:ResultEvent):void
			{
				var l302Response:Object=event.result;
				if(l302Response.state)
				{
					Alert.show("0"==state?"修改成功":"保存成功！","系统提示",1,this,closeHandler);
					return ;
				}
				save.enabled=true;
				Alert.show(l302Response.errorMessage,"系统提示");
			}
			
		
			/**
			 *
			 */
			private function closeHandler(event:CloseEvent):void
			{
				if(event.detail==1)
					this.dispatchEvent(new Event("saveSuccess"));
			}
			
		
			
			
		]]>
	</fx:Script>
	<s:Scroller x="-6" y="1" width="100%" height="100%" horizontalScrollPolicy="auto"
				verticalScrollPolicy="auto">
		<s:VGroup paddingBottom="20" paddingLeft="10" paddingRight="10" paddingTop="10" id="vg">
			<s:HGroup width="100%" horizontalAlign="center">
				<s:Label color="#F11616" fontSize="20" text="登记此项必须先登记妇科检查，细胞学检查!"/>
			</s:HGroup>
			<mx:TabNavigator width="900" chromeColor="#ffffff" creationPolicy="all">
				<s:NavigatorContent width="100%" label="初筛临床建议">			
					<s:VGroup paddingBottom="2" paddingLeft="10" paddingRight="10">	
						<s:HGroup width="100%" height="100%" paddingBottom="3" verticalAlign="middle" id="L302_75">
							<s:RadioButton label="1.定期检查" groupName="L302_75"  width="86" buttonMode="true" 
										   selected="true" value="1"
										   change="CompMethod.hasNumEles(L302_170)"/>
							<s:RadioButton label="2.阴道镜检查" groupName="L302_75"  width="100" 
										   buttonMode="true" value="2"
										   change="CompMethod.hasNumEles(L302_170)"/>
							<s:RadioButton label="3.其他" groupName="L302_75"   buttonMode="true"
										   id="L302_75_09" value="9"/>
							<s:TextInput width="100%" id="L302_170" enabled="{L302_75_09.selected}"/>
						</s:HGroup>
						<s:HGroup width="100%" height="100%" paddingBottom="5" verticalAlign="middle">
							<s:Label text="评估机构"/><s:DropDownList id="L302_171" width="130" enabled="false"/>
							<s:Label text="评估医师"/><component:FindSelectedItemComboBox editable="true"  height="21" id="L302_172" width="130"/>
							<s:Label text="评估时间"/>
							<component:CustomRangeDateField  id="L302_173"  isSelectNow="{'0'!=state}"/>
							
						</s:HGroup>
					</s:VGroup>
				</s:NavigatorContent>
			</mx:TabNavigator>
			<s:HGroup width="800" height="30" contentBackgroundColor="#FF0000"
					  horizontalAlign="center" paddingBottom="20" paddingLeft="10" paddingTop="10"
					  verticalAlign="middle">
				<s:Button id="save" label="保存" buttonMode="true" click="saveCsjy()"/>
			</s:HGroup>
		</s:VGroup>
	</s:Scroller>
</s:VGroup>
