<?xml version="1.0" encoding="utf-8"?>
<s:TitleWindow xmlns:fx="http://ns.adobe.com/mxml/2009"
			   xmlns:s="library://ns.adobe.com/flex/spark"
			   xmlns:mx="library://ns.adobe.com/flex/mx"
			   xmlns:component="com.xyw.sys.custom.component.*"
			   cornerRadius="5" chromeColor="#6EE0ED"
			   width="832" height="374" close="removeWindow()" 
			   creationComplete="moduleCreationComplete()" title="高危登记">
	<fx:Declarations>
		<s:RemoteObject id="f308Service" destination="f308Service" endpoint="{this.parentApplication.contextRoot}/messagebroker/amf" showBusyCursor="true">
			<s:method name="saveF308"  result="saveF308Handler(event)"/>
		</s:RemoteObject>
		
		<s:RemoteObject id="systemService" destination="systemService" endpoint="{this.parentApplication.contextRoot}/messagebroker/amf" showBusyCursor="true">
			<s:method name="getComboBoxData" result="getComboBoxDataHandler(event)"/>
		</s:RemoteObject>
		
		<mx:DateValidator id="dateValidator"  property="text"
						  inputFormat="yyyy-mm-dd" 
						  wrongLengthError="格式错误  正确格式例：2008-01-01"
						  wrongDayError="天数错误"
						  wrongMonthError="月份错误"
						  wrongYearError="年份错误"
						  invalidCharError="内容无效"
						  requiredFieldError="内容不能为空"/>
		
	</fx:Declarations>
	
		<fx:Style>
		@namespace s "library://ns.adobe.com/flex/spark";
		@namespace mx "library://ns.adobe.com/flex/mx";
		mx|GridItem
		{
			horizontalAlign:left;
			verticalAlign:middle;
		}
		s|TextInput
		{
			fontFamily:微软雅黑;
		}
		s|Button
		{
			skinClass:ClassReference("com.xyw.sys.custom.skin.CustomButtonSkin");
		}
		s|DropDownList
		{
			skinClass:ClassReference("com.xyw.sys.custom.skin.CustomDropDownListSkin");
			selectionColor:#DDDDDD;
			rollOverColor:#EEEEEE;	
		}
		.must {
			color:red;
			fontSize:20px;
			fontWeight:bold;
			paddingTop:5px;
		}
	</fx:Style>
	<fx:Script>
		<![CDATA[
			import com.xyw.module.fnbj.fnjcdj.gwfxpg;
			import com.xyw.module.fnbj.model.F301Request;
			import com.xyw.module.fnbj.model.F308;
			import com.xyw.sys.custom.component.CompMethod;
			import com.xyw.sys.model.ComboBoxDataRequest;
			import com.xyw.sys.model.SystemUser;
			
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.controls.DateField;
			import mx.managers.PopUpManager;
			import mx.managers.ToolTipManager;
			import mx.rpc.events.ResultEvent;
			import mx.utils.StringUtil;
			
			private var f301Request:F301Request;
			private var f308:F308;
			private var comboBoxDataRequest:ComboBoxDataRequest;
			[Bindable]
			private var systemUser:SystemUser =null;
			public var vf301:Object;
			public var arrayTip:Array=[null,null,null,null];//保存提示信息  objId:Object,objType:String,errorString:String,tip:ToolTip
			[Bindable]
			private var f308_14:String;
			
			
			private function removeWindow():void
			{
				PopUpManager.removePopUp(this);
			}
			
			private function removeWindow_re(event:Event):void
			{
				PopUpManager.removePopUp(this);
				dispatchEvent(new Event("save_ok"));
			}
			public function moduleCreationComplete():void
			{
				//	ToolTipManager.hideDelay = Infinity; //提示持续时间，Infinity表示一直不消失直到鼠标移走
				//	ToolTipManager.showDelay = 0; //提示信息到鼠标的距离
				this.systemUser =this.parentApplication.systemUser;
				initializeComboBox();
				f308=new F308();
				f308.f30802=vf301.f30101;
				F308_03.text=vf301.f30102;
				
				F308_05.text=vf301.f30105;
				F308_06.text=vf301.f30117;
				F308_07.selectedDate=vf301.f30106;
				F308_10.text=vf301.f30113;
				
			}
			protected function overAndUp(event:MouseEvent):void
			{
				if(event.type==MouseEvent.ROLL_OVER)
				{ 
					if(!arrayTip[3])
						arrayTip=CompMethod.showTip(arrayTip[0],arrayTip[1],arrayTip[2],arrayTip[3]);
					if(!this.hasEventListener(Event.ENTER_FRAME))
						this.addEventListener(Event.ENTER_FRAME,enterFrameHandler); 
				}else
				{
					this.removeEventListener(Event.ENTER_FRAME,enterFrameHandler);			
					arrayTip[3]=CompMethod.destoryTip(arrayTip[3]);		
				}
				
			}
			private function enterFrameHandler(event:Event):void
			{
				if(arrayTip[3])	
					arrayTip=CompMethod.showTip(arrayTip[0],arrayTip[1],arrayTip[2],arrayTip[3]);		 
			}
			private function initializeComboBox():void
			{
				comboBoxDataRequest =new ComboBoxDataRequest();
				comboBoxDataRequest.showPrompt =true;
				comboBoxDataRequest.flag ="D101";
				comboBoxDataRequest.sql ="select t.d101_01, t.d101_02 from D101 t where t.d101_01 = '" + this.systemUser.institutionCode + "' or t.d101_11 ='" + this.systemUser.institutionCode +"'";
				this.systemService.getComboBoxData(this.comboBoxDataRequest);
				
				comboBoxDataRequest = new ComboBoxDataRequest();
				comboBoxDataRequest.showPrompt = true;
				comboBoxDataRequest.sql = "select * from S301_06 t";
				comboBoxDataRequest.flag = "S301_06";
				this.systemService.getComboBoxData(this.comboBoxDataRequest);
				
				comboBoxDataRequest = new ComboBoxDataRequest();
				comboBoxDataRequest.showPrompt = true;
				comboBoxDataRequest.sql = "select * from S402_04 t";
				comboBoxDataRequest.flag = "S402_04";
				this.systemService.getComboBoxData(this.comboBoxDataRequest);
				
				comboBoxDataRequest = new ComboBoxDataRequest();
				comboBoxDataRequest.showPrompt = true;
				comboBoxDataRequest.sql = "select * from S402_05 t";
				comboBoxDataRequest.flag = "S402_05";
				this.systemService.getComboBoxData(this.comboBoxDataRequest);
				
				comboBoxDataRequest = new ComboBoxDataRequest();
				comboBoxDataRequest.showPrompt = true;
				comboBoxDataRequest.sql = "select * from S601_04 t";
				comboBoxDataRequest.flag = "S601_04";
				this.systemService.getComboBoxData(this.comboBoxDataRequest);
			}
			/*-----------------返回数据放到赋值到下拉菜单-----------------*/
			private function getComboBoxDataHandler(event:ResultEvent):void
			{
				var index:int=0;
				var comboBoxDataResponse:Object =event.result;
				var flag:String =comboBoxDataResponse.flag;
				var comboBoxDataList:ArrayCollection =comboBoxDataResponse.comboBoxDataList;
				
				if(flag =="D101"){
					index=CompMethod.getDropDownListSelectedIndex(comboBoxDataList,this.systemUser.institutionCode);
					this.F308_16.dataProvider =comboBoxDataList;
					this.F308_16.selectedIndex =index;
				}else if(flag == "S301_06"){
					
					this.F308_04.dataProvider = comboBoxDataList;
					F308_04.selectedIndex=CompMethod.getDropDownListSelectedIndex(ArrayCollection(F308_04.dataProvider),vf301.f30104);
					
				}else if(flag == "S402_04"){
					this.F308_13.dataProvider = comboBoxDataList;
					this.F308_13.selectedIndex = index;
				}else if(flag == "S402_05"){
					this.F308_11.dataProvider = comboBoxDataList;
					this.F308_11.selectedIndex = index;
				}else if(flag == "S601_04"){
					this.F308_12.dataProvider = comboBoxDataList;
					this.F308_12.selectedIndex = index;
				}
				
			}
			
			/**
			 *时间输入验证
			 */
			private function focusOut(id:Object):Boolean
			{
				var textDate:Date=DateField.stringToDate(id.text,"YYYY-MM-DD");
				if(id.errorString&&!textDate)
				{
					var str:String=id.errorString;
					id.errorString='';
					dateValidator.source=null;
					if((str.lastIndexOf("yyyy-mm-dd"))!=-1)
						str=str.substring(0,str.lastIndexOf("yyyy-mm-dd"));
					//保存提示信息  objId:Object,objType:String,errorString:String,tip:ToolTip
					arrayTip=CompMethod.showTip(id,"3",str,arrayTip[3]);
					return true;
				}else
					return dateValidatorHandler(id,textDate);
			}
			
			/**
			 *清空提示 格式化日期
			 */
			private function dateValidatorHandler(id:Object,textDate:Date):Boolean
			{
				dateValidator.source=null;
				id.errorString='';
				if(arrayTip[3])
				{
					CompMethod.destoryTip(arrayTip[3]);	
					arrayTip=[null,null,null,null]
				}					
				if(textDate)
					id.text=DateField.dateToString(textDate,"YYYY-MM-DD");
				return false;
			}
			
			private function gaowei_clickHandler(event:MouseEvent):void
			{
				var gw:gwfxpg = new gwfxpg();
				CompMethod.popUpTitleWindow(gw,this,true);
				
			}
			
			//读卡(母亲)
			protected function readCard_mother(event:MouseEvent):void
			{
				try
				{
					//readCard是调用index.js下的函数，读卡涉及index.jsp和index.js两个文件
					var str:String = ExternalInterface.call("parent.readCard");
					if(str != null && str.length != 0){
						
						var array:Array = str.split(",");
						var sex:String = array[1];//性别
						if(sex=="女"){
							this.F308_03.text = array[0];//姓名
							this.F308_05.text = array[5];//身份证号
							this.F308_07.text = array[3];//出生日期
							//	setF303_08(null);
							var nation:String = array[2] + "族";//民族
						}else{
							Alert.show("请读母亲信息！","系统提示");
						}
					}else{
						Alert.show("读卡失败！");
					}
				} 
				catch(error:Error) 
				{
					Alert.show("读卡失败！");
				}
			}
			
			private function validatePerinata():void
			{
				if(arrayTip[3])
					return;
				if(StringUtil.trim(F308_10.text)=="")
				{
					Alert.show("请输入电话号码","系统提示");
					return;
				}
				if(StringUtil.trim(F308_08.text)=="")
				{
					Alert.show("请输入孕周","系统提示");
					return;
				}
				if(StringUtil.trim(F308_09.text)=="")
				{
					Alert.show("请输入天数","系统提示");
					return;
				}
				if(!F308_11.selectedIndex)
				{
					Alert.show("请选择产前产后","系统提示");
					return;
				}
				
				if(!F308_13.selectedIndex)
				{
					Alert.show("请点击高危评估按钮","系统提示");
					return;
				}
				
				if(F308_13.selectedIndex>2)
				{
					if(!F308_12.selectedIndex)
					{
						Alert.show("请选择是否转诊","系统提示");
						return;
					}
				}
				if(StringUtil.trim(F308_07.text)==""){
					Alert.show("请输入出生日期","系统提示");
					return;
				}
				
				if(StringUtil.trim(F308_15.text)=="")
				{
					Alert.show("请输入建档人","系统提示");
					return;
				}
				if(StringUtil.trim(F308_17.text)=="")
				{
					Alert.show("请输入建档日期","系统提示");
					return;
				}
				saveF308();
			}
			
			private function saveF308():void
			{
				save.enabled=false;
				f308.f30803=StringUtil.trim(F308_03.text);
				f308.f30804=F308_04.selectedItem.data;
				f308.f30805=StringUtil.trim(F308_05.text);
				f308.f30806=StringUtil.trim(F308_06.text);
				f308.f30807=F308_07.selectedDate;
				f308.f30808=StringUtil.trim(F308_08.text);
				f308.f30809=StringUtil.trim(F308_09.text);
				f308.f30810=StringUtil.trim(F308_10.text);
				f308.f30811=F308_11.selectedItem.data;
				f308.f30812=F308_12.selectedItem.data;
				f308.f30813=F308_13.selectedItem.data;
				f308.f30814=F308_14.text?F308_14.text:f308_14;
				f308.f30815=StringUtil.trim(F308_15.text);
				f308.f30816=F308_16.selectedItem.data;
				f308.f30817=DateField.stringToDate(F308_17.text,'YYYY-MM-DD');
				f308Service.saveF308(f308);
			}
			
			private function saveF308Handler(event:ResultEvent):void
			{
				var f308Response:Object=event.result;
				if(f308Response.state)
				{
					Alert.show("保存成功！","系统提示",1,this,removeWindow_re);
				}else
				{
					save.enabled=true;
					Alert.show(f308Response.errorMessage,"系统提示");				
				}
			}
			
			/**
			 *得到所选择的信息 
			 */
			public function getColor(allColor:Array):void
			{
				for(var i:int=allColor.length-1;i>-1;i--)
				{
					if(allColor[i].length)
					{
						if(i>1)
							getGWMessage(allColor[i]);
						else
							setGW();
						F308_13.selectedIndex=++i;
						F308_14.toolTip=F308_14.text;
						break;
					}else
						setGW(true);
				}
			}
			/**
			 *恢复初始化
			 */
			private function setGW(flag:Boolean=false):void
			{
				
				if(flag)
					F308_13.selectedIndex=0;
				F308_14.text="无"
				F308_14.toolTip=F308_14.text;
				
			}
			/**
			 *得到选择的名称
			 */
			private function getGWMessage(arrMessage:Array):void
			{
				F308_14.text=f308_14="";
				for(var i:String in arrMessage)
				{
					f308_14+=arrMessage[i][0]+"!";
					F308_14.text+=arrMessage[i][0]+"\n";
				}
				
			}
			
		]]>
	</fx:Script>
	
	<s:VGroup width="820" height="313" paddingBottom="20" paddingLeft="10" paddingRight="10"
			  paddingTop="10" chromeColor="#cccccc">
		<mx:TabNavigator width="801" height="166" id="content" chromeColor="#ffffff" creationPolicy="all">
			<s:NavigatorContent width="100%" label="基本信息">	
				
				<mx:Grid width="799" paddingBottom="10" paddingLeft="8">
					<mx:GridRow>
						<mx:GridItem>
							<s:Label text="孕 妇  姓 名"/>	
							<s:TextInput id="F308_03" width="130" editable="false"/>	
						</mx:GridItem>
						<mx:GridItem>
							<s:Label text="证件类型" paddingLeft="15"/>
							<component:CustomDropDownList id="F308_04" width="205" enabled="false"/>
							
						</mx:GridItem>
						<mx:GridItem>
							<s:Label text="证件号码" paddingLeft="15"/>
							<s:TextInput id="F308_05" width="140" editable="false"/>
							
						</mx:GridItem>
						
					</mx:GridRow>
					<mx:GridRow>	
						<mx:GridItem>
							<s:Label text="联 系  电 话" />
							<s:TextInput id="F308_10" restrict="0-9"/>
							
						</mx:GridItem>
						
						<mx:GridItem>
							<s:Label text="孕  周  天" paddingLeft="15"/>
							<s:BorderContainer  height="23" width="205">
								<s:HGroup x="0" y="0" width="210" verticalAlign="middle">
									<s:TextInput id="F308_08" width="87" borderVisible="false"
												 maxChars="2" restrict="0-9" text="40"
												 textAlign="right"/>
									<s:Label text="周    "/>
									<s:TextInput id="F308_09" y="-1" width="74" 
												 borderVisible="false" maxChars="1"
												 restrict="0-6" text="0" textAlign="right"/>
									<s:Label text="天    "/>
								</s:HGroup>
							</s:BorderContainer>
							
						</mx:GridItem>
						<mx:GridItem>
							<s:Label text="产前产后" paddingLeft="15"/>
							<s:DropDownList id="F308_11" width="140"  enabled="{F308_03.text}"/>
						</mx:GridItem>
						
					</mx:GridRow>
					<mx:GridRow>
						<mx:GridItem>
							<s:Label text="建 册  编 号" paddingLeft="0"/>	
							<s:TextInput id="F308_06" width="130" editable="false"/>
							
						</mx:GridItem>
						<mx:GridItem>
							<s:Label text="出生日期" paddingLeft="15"/>
							
							<component:CustomRangeDateField id="F308_07" width="130"/>
							<s:Button buttonMode="true" label="读卡" id="duka2" enabled="{systemUser.duka =='1'}"  click="readCard_mother(event)"/>
						</mx:GridItem>
						<mx:GridItem>
							<s:Label text="是否转诊" paddingLeft="15"/>
							<s:DropDownList id="F308_12" width="140" enabled="{F308_13.selectedIndex>2}" color="#E61717"/>
							<s:Button buttonMode="true" label="高危评估" id="gaowei" click="gaowei_clickHandler(event)" enabled="{F308_03.text}"/>
						</mx:GridItem>
					</mx:GridRow>
					<mx:GridRow>
						<mx:GridItem>
							<s:Label text="高 危  级 别" />
							<s:DropDownList id="F308_13" width="130" enabled="false" color="#E61717"  
											change="if(F308_13.selectedIndex&lt;2)F308_12.selectedIndex=0"/>
						</mx:GridItem>
						<mx:GridItem  colSpan="2">
							<s:Label text="高危原因" paddingLeft="15"/>
							<s:TextInput id="F308_14" editable="false"
										 text="无"  width="427"/>
						</mx:GridItem>
						
					</mx:GridRow>
				</mx:Grid>
			</s:NavigatorContent>
		</mx:TabNavigator>
		<mx:TabNavigator width="801" chromeColor="#ffffff" creationPolicy="all">
			<s:NavigatorContent width="100%" label="登记信息">	
				<mx:Grid paddingLeft="8" paddingBottom="10">
					<mx:GridRow>
						<mx:GridItem>
							<s:Label text="建档人员"/>
							<s:TextInput id="F308_15" width="130"/>
							
						</mx:GridItem>
						<mx:GridItem>
							<s:Label text="建档医院" paddingLeft="20"/>
							<component:CustomDropDownList id="F308_16" width="130" enabled="false"/>
							
						</mx:GridItem>
						<mx:GridItem>
							<s:Label text="建档时间" paddingLeft="10"/>
							
							<component:CustomRangeDateField id="F308_17" width="140"/>
						</mx:GridItem>
					</mx:GridRow>
				</mx:Grid>
			</s:NavigatorContent>
		</mx:TabNavigator>
		<s:HGroup verticalAlign="middle" horizontalAlign="center" paddingBottom="5" paddingTop="5" width="1155">
			<s:Button buttonMode="true" id="save" label="保存" click="validatePerinata()"  enabled="{F308_03.text}"/>
		</s:HGroup>
	</s:VGroup>
</s:TitleWindow>
